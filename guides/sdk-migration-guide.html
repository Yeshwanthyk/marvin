<!DOCTYPE html>
<html lang="en" data-theme="dark" data-font="departure">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SDK-Ready Merlin Migration Guide</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:ital,wght@0,400;0,500;0,600;1,400&family=IBM+Plex+Mono:wght@400;500&family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&family=Source+Sans+3:ital,wght@0,400;0,600;1,400&family=Source+Code+Pro:wght@400;500&family=Crimson+Pro:ital,wght@0,400;0,500;0,600;1,400&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-typescript.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-rust.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-go.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-yaml.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-swift.min.js" defer></script>
<style>
@font-face {
  font-family: 'Departure Mono';
  src: url('data:font/woff2;base64,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') format('woff2');
  font-weight: normal;
  font-display: swap;
}

:root {
  --bg: #131313;
  --bg2: #1a1a1a;
  --bg3: #242424;
  --text: #e8e8e8;
  --text2: #a0a0a0;
  --text3: #606060;
  --accent: #f0a050;
  --accent2: #c07828;
  --border: #2e2e2e;
}
[data-theme="light"] {
  --bg: #fafafa;
  --bg2: #f0f0f0;
  --bg3: #e4e4e4;
  --text: #1a1a1a;
  --text2: #555;
  --text3: #999;
  --accent: #d06020;
  --accent2: #a04010;
  --border: #ddd;
}

/* Font families */
[data-font="departure"] { --sans: 'Departure Mono', monospace; --mono: 'Departure Mono', monospace; --prose-size: 1.05rem; }
[data-font="plex"] { --sans: 'IBM Plex Sans', system-ui, sans-serif; --mono: 'IBM Plex Mono', monospace; --prose-size: 1.15rem; }
[data-font="inter"] { --sans: 'Inter', system-ui, sans-serif; --mono: 'JetBrains Mono', monospace; --prose-size: 1.1rem; }
[data-font="source"] { --sans: 'Source Sans 3', system-ui, sans-serif; --mono: 'Source Code Pro', monospace; --prose-size: 1.15rem; }
[data-font="crimson"] { --sans: 'Crimson Pro', Georgia, serif; --mono: 'DM Mono', monospace; --prose-size: 1.2rem; }

* { margin: 0; padding: 0; box-sizing: border-box; }
html { font-size: 18px; scroll-behavior: smooth; scroll-padding-top: 48px; }
body { font-family: var(--sans); background: var(--bg); color: var(--text); line-height: 1.7; -webkit-font-smoothing: antialiased; }

/* Top bar */
.topbar { position: fixed; top: 0; left: 0; right: 0; height: 42px; background: var(--bg2); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 20px; gap: 16px; font-family: var(--mono); font-size: 12px; color: var(--text3); z-index: 100; }
.topbar .progress { position: absolute; bottom: 0; left: 0; height: 2px; background: var(--accent); width: 0; }
.topbar .pct { color: var(--accent); min-width: 42px; font-weight: 500; }
.topbar .spacer { flex: 1; }
.topbar .font-btn { background: var(--bg3); border: 1px solid var(--border); border-radius: 4px; padding: 5px 12px; font-family: var(--mono); font-size: 11px; color: var(--text2); cursor: pointer; transition: all 0.15s; min-width: 90px; text-align: center; }
.topbar .font-btn:hover { background: var(--border); color: var(--text); }

/* Layout */
.wrap { display: flex; min-height: 100vh; padding-top: 42px; }

/* TOC */
.toc { position: fixed; top: 42px; left: 0; width: 250px; height: calc(100vh - 42px); background: var(--bg); border-right: 1px solid var(--border); padding: 28px 0; overflow-y: auto; z-index: 50; transition: transform 0.2s; }
.toc.hidden { transform: translateX(-100%); }
.toc-title { padding: 0 20px 20px; font-family: var(--mono); font-size: 11px; font-weight: 500; letter-spacing: 0.12em; color: var(--text3); text-transform: uppercase; }
.toc-list { list-style: none; }
.toc-item { display: flex; align-items: center; gap: 12px; padding: 0 16px; }
.toc-l2 { padding-left: 32px; }
.toc-l3 { padding-left: 48px; }
.toc-l4 { padding-left: 64px; }
.toc-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--border); flex-shrink: 0; transition: all 0.2s; }
.toc-dot.active { background: var(--accent); box-shadow: 0 0 8px var(--accent); }
.toc-link { display: block; padding: 8px 0; font-size: 13px; color: var(--text2); text-decoration: none; flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; transition: color 0.15s; }
.toc-link:hover { color: var(--text); }
.toc-link.active { color: var(--accent); font-weight: 500; }

/* Content */
.content { flex: 1; margin-left: 250px; padding: 56px 72px 140px; max-width: 1040px; transition: margin 0.2s; }
.toc.hidden + .content { margin-left: 0; }

/* Header */
.doc-header { margin-bottom: 56px; }
.doc-title { font-size: 2.8rem; font-weight: 600; line-height: 1.1; letter-spacing: -0.03em; margin-bottom: 20px; }
.doc-info { display: flex; flex-wrap: wrap; align-items: center; gap: 8px 20px; font-size: 15px; color: var(--text2); }
.doc-info .sep { color: var(--border); }
.doc-info .status { font-family: var(--mono); font-size: 11px; font-weight: 500; letter-spacing: 0.06em; color: var(--accent); background: color-mix(in srgb, var(--accent) 15%, transparent); padding: 5px 12px; border-radius: 4px; }
.doc-info .tags { color: var(--text3); }

/* Prose */
.prose { font-size: var(--prose-size); line-height: 1.85; max-width: 72ch; }
.prose > *:first-child { margin-top: 0; }

.prose h1, .prose h2, .prose h3, .prose h4 { font-weight: 600; line-height: 1.25; letter-spacing: -0.02em; margin: 2.5em 0 0.8em; }
.prose h1 { font-size: 2.1rem; margin-top: 3em; padding-bottom: 0.5em; border-bottom: 1px solid var(--border); }
.prose h2 { font-size: 1.65rem; margin-top: 2.5em; }
.prose h3 { font-size: 1.3rem; margin-top: 2em; }
.prose h4 { font-size: 1.1rem; margin-top: 1.5em; }
.section-num { font-family: var(--mono); font-size: 0.65em; font-weight: 500; color: var(--accent); margin-right: 0.6em; opacity: 0.9; }

.prose p { margin: 0 0 1.3em; }
.prose a { color: var(--accent); text-decoration: underline; text-decoration-color: var(--accent2); text-underline-offset: 3px; }
.prose a:hover { text-decoration-color: var(--accent); }
.prose strong { font-weight: 600; }

.prose ul, .prose ol { margin: 0 0 1.3em; padding-left: 1.6em; }
.prose li { margin-bottom: 0.5em; }
.prose li::marker { color: var(--text3); }

.task { list-style: none; margin-left: -1.6em; display: flex; gap: 0.7em; align-items: flex-start; }
.checkbox { font-family: var(--mono); color: var(--text3); flex-shrink: 0; }
.task.checked { color: var(--text3); }
.task.checked .checkbox { color: var(--accent); }

.prose blockquote { margin: 1.6em 0; padding: 1.1em 1.5em; background: var(--bg2); border-left: 3px solid var(--accent); border-radius: 0 6px 6px 0; }
.prose blockquote p:last-child { margin-bottom: 0; }

.prose code { font-family: var(--mono); font-size: 0.85em; background: var(--bg2); padding: 0.2em 0.5em; border-radius: 4px; color: var(--accent); }

.prose hr { border: none; height: 1px; background: var(--border); margin: 3.5em 0; }

.prose .img-figure { margin: 2em 0; }
.prose .img-figure img { max-width: 100%; border-radius: 8px; border: 1px solid var(--border); }
.prose .img-figure figcaption { font-size: 0.85em; color: var(--text3); margin-top: 0.7em; text-align: center; }

.prose .table-wrap { overflow-x: auto; margin: 1.6em 0; border-radius: 8px; border: 1px solid var(--border); }
.prose table { width: 100%; border-collapse: collapse; font-size: 0.92em; }
.prose th, .prose td { padding: 0.85em 1.1em; text-align: left; border-bottom: 1px solid var(--border); }
.prose th { background: var(--bg2); font-weight: 600; font-size: 0.85em; }
.prose tr:last-child td { border-bottom: none; }

.wikilink { color: var(--accent); background: color-mix(in srgb, var(--accent) 12%, transparent); padding: 0.15em 0.45em; border-radius: 4px; }

/* Code blocks */
.code-block { margin: 2.2em 0; background: var(--bg2); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
.code-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px 16px; background: var(--bg3); border-bottom: 1px solid var(--border); }
.code-lang { font-family: var(--mono); font-size: 11px; font-weight: 500; color: var(--text3); }
.code-copy { font-family: var(--mono); font-size: 11px; background: transparent; border: 1px solid var(--border); border-radius: 4px; padding: 5px 12px; color: var(--text3); cursor: pointer; transition: all 0.15s; }
.code-copy:hover { color: var(--text); border-color: var(--text3); }
.code-copy.copied { color: var(--accent); border-color: var(--accent); }
.code-block pre { margin: 0; padding: 1.4em 1.6em; overflow-x: auto; background: transparent !important; }
.code-block pre code { font-family: var(--mono); font-size: 14px; line-height: 1.65; background: none !important; padding: 0 !important; color: var(--text) !important; }

/* Prism */
.token.comment, .token.prolog { color: #6a737d; }
.token.property, .token.tag, .token.boolean, .token.number, .token.constant, .token.symbol { color: #79c0ff; }
.token.selector, .token.attr-name, .token.string, .token.char, .token.builtin { color: #a5d6ff; }
.token.operator, .token.entity, .token.url { color: #ffa657; }
.token.atrule, .token.attr-value, .token.keyword { color: #ff7b72; }
.token.function, .token.class-name { color: #d2a8ff; }
.token.inserted { color: #7ee787; }
.token.deleted { color: #ffa198; }

/* Keyboard bar */
.kb { position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg2); border-top: 1px solid var(--border); padding: 10px 24px; z-index: 90; display: flex; justify-content: center; gap: 28px; font-family: var(--mono); font-size: 12px; color: var(--text3); }
kbd { display: inline-block; min-width: 20px; padding: 3px 8px; background: var(--bg3); border: 1px solid var(--border); border-radius: 4px; font-family: var(--mono); font-size: 11px; color: var(--text2); text-align: center; margin: 0 2px; }

/* Help */
.help { position: fixed; inset: 0; background: rgba(0,0,0,0.65); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 200; opacity: 0; visibility: hidden; transition: all 0.2s; }
.help.show { opacity: 1; visibility: visible; }
.help-box { background: var(--bg2); border: 1px solid var(--border); border-radius: 12px; padding: 32px 40px; min-width: 380px; box-shadow: 0 24px 80px rgba(0,0,0,0.5); }
.help-title { font-family: var(--mono); font-size: 12px; font-weight: 500; letter-spacing: 0.12em; color: var(--accent); margin-bottom: 24px; text-transform: uppercase; }
.help-row { display: flex; justify-content: space-between; align-items: center; padding: 11px 0; font-size: 14px; border-bottom: 1px solid var(--border); }
.help-row:last-child { border-bottom: none; }
.help-row span:last-child { color: var(--text3); }

/* Responsive */
@media (max-width: 1024px) {
  .toc { transform: translateX(-100%); }
  .toc.show { transform: translateX(0); box-shadow: 4px 0 24px rgba(0,0,0,0.4); }
  .content { margin-left: 0 !important; }
}
@media (max-width: 640px) {
  html { font-size: 16px; }
  .content { padding: 36px 24px 120px; }
  .doc-title { font-size: 2rem; }
  .kb { gap: 16px; font-size: 11px; }
}
@media print {
  .toc, .topbar, .kb, .help { display: none !important; }
  .content { margin: 0 !important; padding: 0; max-width: 100%; }
  body { background: #fff; color: #000; font-size: 11pt; }
}

::-webkit-scrollbar { width: 8px; }
::-webkit-scrollbar-track { background: var(--bg); }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
::selection { background: var(--accent); color: #000; }
</style>
</head>
<body>
<div class="topbar">
  <div class="progress" id="progress"></div>
  <span class="pct" id="pct">0%</span>
  <span id="pos">1 / 149</span>
  <span>61 min</span>
  <span class="spacer"></span>
  <button class="font-btn" id="fontBtn" title="Cycle fonts (F)">Departure</button>
</div>

<div class="wrap">
<nav class="toc" id="toc"><div class="toc-title">Contents</div><ul class="toc-list"><li class="toc-item toc-l1"><span class="toc-dot" data-section="1"></span><a href="#h-sdk-ready-merlin-repo-migration-implementation-guide-1" class="toc-link" data-section="1">SDK-ready merlin repo migration implementation guide</a></li><li class="toc-item toc-l2"><span class="toc-dot" data-section="2"></span><a href="#h-table-of-contents-2" class="toc-link" data-section="2">Table of Contents</a></li><li class="toc-item toc-l2"><span class="toc-dot" data-section="3"></span><a href="#h-background-and-context-3" class="toc-link" data-section="3">Background and context</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="4"></span><a href="#h-why-we-are-doing-this-4" class="toc-link" data-section="4">Why we are doing this</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="5"></span><a href="#h-naming-baseline-assumed-in-this-guide-5" class="toc-link" data-section="5">Naming baseline (assumed in this guide)</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="6"></span><a href="#h-what-quotsdk-readyquot-means-here-6" class="toc-link" data-section="6">What &amp;quot;SDK-ready&amp;quot; means here</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="7"></span><a href="#h-how-the-current-system-works-mental-model-7" class="toc-link" data-section="7">How the current system works (mental model)</a></li><li class="toc-item toc-l4"><span class="toc-dot" data-section="8"></span><a href="#h-package-layering-8" class="toc-link" data-section="8">Package layering</a></li><li class="toc-item toc-l4"><span class="toc-dot" data-section="9"></span><a href="#h-tool-pipeline-tui-and-headless-9" class="toc-link" data-section="9">Tool pipeline (TUI and headless)</a></li><li class="toc-item toc-l4"><span class="toc-dot" data-section="10"></span><a href="#h-mode-entrypoints-10" class="toc-link" data-section="10">Mode entrypoints</a></li><li class="toc-item toc-l4"><span class="toc-dot" data-section="11"></span><a href="#h-key-coupling-issues-to-remove-for-sdk-readiness-11" class="toc-link" data-section="11">Key coupling issues to remove for SDK readiness</a></li><li class="toc-item toc-l2"><span class="toc-dot" data-section="12"></span><a href="#h-key-files-to-understand-read-these-in-the-old-repo-12" class="toc-link" data-section="12">Key files to understand (read these in the old repo)</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="13"></span><a href="#h-core-files-quick-reference-13" class="toc-link" data-section="13">Core Files - Quick Reference</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="14"></span><a href="#h-deep-dive-packagesbase-tools-14" class="toc-link" data-section="14">Deep Dive: packages/base-tools</a></li><li class="toc-item toc-l4"><span class="toc-dot" data-section="15"></span><a href="#h-path-utilsts-current-implementation-15" class="toc-link" data-section="15">path-utils.ts - Current Implementation</a></li><li class="toc-item toc-l4"><span class="toc-dot" data-section="16"></span><a href="#h-readts-current-implementation-16" class="toc-link" data-section="16">read.ts - Current Implementation</a></li><li class="toc-item toc-l4"><span class="toc-dot" data-section="17"></span><a href="#h-bashts-current-implementation-17" class="toc-link" data-section="17">bash.ts - Current Implementation</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="18"></span><a href="#h-deep-dive-appscoding-agentsrcconfigts-18" class="toc-link" data-section="18">Deep Dive: apps/coding-agent/src/config.ts</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="19"></span><a href="#h-deep-dive-codex-instructions-cache-19" class="toc-link" data-section="19">Deep Dive: Codex Instructions Cache</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="20"></span><a href="#h-deep-dive-token-storage-20" class="toc-link" data-section="20">Deep Dive: Token Storage</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="21"></span><a href="#h-deep-dive-session-manager-21" class="toc-link" data-section="21">Deep Dive: Session Manager</a></li><li class="toc-item toc-l2"><span class="toc-dot" data-section="22"></span><a href="#h-patterns-to-follow-22" class="toc-link" data-section="22">Patterns to follow</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="23"></span><a href="#h-agenttool-pattern-schema-execute-abort-handling-23" class="toc-link" data-section="23">AgentTool pattern (schema + execute + abort handling)</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="24"></span><a href="#h-hook-wiring-pattern-register-events-call-send-24" class="toc-link" data-section="24">Hook wiring pattern (register events, call send)</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="25"></span><a href="#h-transport-composition-pattern-25" class="toc-link" data-section="25">Transport composition pattern</a></li><li class="toc-item toc-l2"><span class="toc-dot" data-section="26"></span><a href="#h-milestone-0-migration-prep-and-guardrails-26" class="toc-link" data-section="26">Milestone 0: Migration prep and guardrails</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="27"></span><a href="#h-goal-27" class="toc-link" data-section="27">Goal</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="28"></span><a href="#h-verification-28" class="toc-link" data-section="28">Verification</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="29"></span><a href="#h-steps-29" class="toc-link" data-section="29">Steps</a></li><li class="toc-item toc-l4"><span class="toc-dot" data-section="30"></span><a href="#h-01-lock-naming-baseline-merlin-from-day-one-30" class="toc-link" data-section="30">1 Lock naming baseline (merlin from day one)</a></li><li class="toc-item toc-l4"><span class="toc-dot" data-section="31"></span><a href="#h-02-freeze-the-baseline-31" class="toc-link" data-section="31">2 Freeze the baseline</a></li><li class="toc-item toc-l4"><span class="toc-dot" data-section="32"></span><a href="#h-03-create-an-audit-checklist-32" class="toc-link" data-section="32">3 Create an audit checklist</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="33"></span><a href="#h-watch-out-for-33" class="toc-link" data-section="33">Watch out for</a></li><li class="toc-item toc-l2"><span class="toc-dot" data-section="34"></span><a href="#h-milestone-1-root-infrastructure-in-the-new-repo-34" class="toc-link" data-section="34">Milestone 1: Root infrastructure in the new repo</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="35"></span><a href="#h-goal-35" class="toc-link" data-section="35">Goal</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="36"></span><a href="#h-verification-36" class="toc-link" data-section="36">Verification</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="37"></span><a href="#h-file-checklist-37" class="toc-link" data-section="37">File checklist</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="38"></span><a href="#h-steps-38" class="toc-link" data-section="38">Steps</a></li><li class="toc-item toc-l4"><span class="toc-dot" data-section="39"></span><a href="#h-11-copy-root-packagejson-39" class="toc-link" data-section="39">1 Copy root package.json</a></li><li class="toc-item toc-l4"><span class="toc-dot" data-section="40"></span><a href="#h-12-copy-bunfigtoml-40" class="toc-link" data-section="40">2 Copy bunfig.toml</a></li><li class="toc-item toc-l4"><span class="toc-dot" data-section="41"></span><a href="#h-13-copy-tsconfigbasejson-41" class="toc-link" data-section="41">3 Copy tsconfig.base.json</a></li><li class="toc-item toc-l4"><span class="toc-dot" data-section="42"></span><a href="#h-14-copy-testsetupts-42" class="toc-link" data-section="42">4 Copy test/setup.ts</a></li><li class="toc-item toc-l4"><span class="toc-dot" data-section="43"></span><a href="#h-15-copy-scriptstest-allts-43" class="toc-link" data-section="43">5 Copy scripts/test-all.ts</a></li><li class="toc-item toc-l4"><span class="toc-dot" data-section="44"></span><a href="#h-16-copy-gitignore-44" class="toc-link" data-section="44">6 Copy .gitignore</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="45"></span><a href="#h-watch-out-for-45" class="toc-link" data-section="45">Watch out for</a></li><li class="toc-item toc-l2"><span class="toc-dot" data-section="46"></span><a href="#h-milestone-2-migrate-packagesai-46" class="toc-link" data-section="46">Milestone 2: Migrate packages/ai</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="47"></span><a href="#h-goal-47" class="toc-link" data-section="47">Goal</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="48"></span><a href="#h-what-this-package-does-48" class="toc-link" data-section="48">What this package does</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="49"></span><a href="#h-verification-49" class="toc-link" data-section="49">Verification</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="50"></span><a href="#h-file-checklist-50" class="toc-link" data-section="50">File checklist</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="51"></span><a href="#h-steps-51" class="toc-link" data-section="51">Steps</a></li><li class="toc-item toc-l4"><span class="toc-dot" data-section="52"></span><a href="#h-21-copy-the-entire-package-52" class="toc-link" data-section="52">1 Copy the entire package</a></li><li class="toc-item toc-l4"><span class="toc-dot" data-section="53"></span><a href="#h-22-update-packagejson-53" class="toc-link" data-section="53">2 Update package.json</a></li><li class="toc-item toc-l4"><span class="toc-dot" data-section="54"></span><a href="#h-23-understand-the-key-types-54" class="toc-link" data-section="54">3 Understand the key types</a></li><li class="toc-item toc-l4"><span class="toc-dot" data-section="55"></span><a href="#h-24-verify-model-generation-workflow-55" class="toc-link" data-section="55">4 Verify model generation workflow</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="56"></span><a href="#h-watch-out-for-56" class="toc-link" data-section="56">Watch out for</a></li><li class="toc-item toc-l2"><span class="toc-dot" data-section="57"></span><a href="#h-milestone-3-migrate-packagesagent-57" class="toc-link" data-section="57">Milestone 3: Migrate packages/agent</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="58"></span><a href="#h-goal-58" class="toc-link" data-section="58">Goal</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="59"></span><a href="#h-what-this-package-does-59" class="toc-link" data-section="59">What this package does</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="60"></span><a href="#h-verification-60" class="toc-link" data-section="60">Verification</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="61"></span><a href="#h-file-checklist-61" class="toc-link" data-section="61">File checklist</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="62"></span><a href="#h-steps-62" class="toc-link" data-section="62">Steps</a></li><li class="toc-item toc-l4"><span class="toc-dot" data-section="63"></span><a href="#h-31-copy-the-package-and-update-metadata-63" class="toc-link" data-section="63">1 Copy the package and update metadata</a></li><li class="toc-item toc-l4"><span class="toc-dot" data-section="64"></span><a href="#h-32-make-codex-instruction-caching-configurable-64" class="toc-link" data-section="64">2 Make Codex instruction caching configurable</a></li><li class="toc-item toc-l4"><span class="toc-dot" data-section="65"></span><a href="#h-33-update-codextransport-to-pass-cachedir-65" class="toc-link" data-section="65">3 Update CodexTransport to pass cacheDir</a></li><li class="toc-item toc-l4"><span class="toc-dot" data-section="66"></span><a href="#h-34-update-codex-auth-cli-defaults-66" class="toc-link" data-section="66">4 Update Codex auth CLI defaults</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="67"></span><a href="#h-watch-out-for-67" class="toc-link" data-section="67">Watch out for</a></li><li class="toc-item toc-l2"><span class="toc-dot" data-section="68"></span><a href="#h-milestone-4-migrate-packagesbase-tools-and-make-tools-cwd-aware-68" class="toc-link" data-section="68">Milestone 4: Migrate packages/base-tools and make tools cwd-aware</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="69"></span><a href="#h-goal-69" class="toc-link" data-section="69">Goal</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="70"></span><a href="#h-what-this-package-does-70" class="toc-link" data-section="70">What this package does</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="71"></span><a href="#h-verification-71" class="toc-link" data-section="71">Verification</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="72"></span><a href="#h-file-checklist-72" class="toc-link" data-section="72">File checklist</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="73"></span><a href="#h-steps-73" class="toc-link" data-section="73">Steps</a></li><li class="toc-item toc-l4"><span class="toc-dot" data-section="74"></span><a href="#h-41-update-package-metadata-74" class="toc-link" data-section="74">1 Update package metadata</a></li><li class="toc-item toc-l4"><span class="toc-dot" data-section="75"></span><a href="#h-42-extend-path-utilities-with-cwd-helpers-75" class="toc-link" data-section="75">2 Extend path utilities with cwd helpers</a></li><li class="toc-item toc-l4"><span class="toc-dot" data-section="76"></span><a href="#h-43-add-tool-factories-76" class="toc-link" data-section="76">3 Add tool factories</a></li><li class="toc-item toc-l4"><span class="toc-dot" data-section="77"></span><a href="#h-44-add-createcodingtools-helper-77" class="toc-link" data-section="77">4 Use createToolRegistry only (no legacy helper)</a></li><li class="toc-item toc-l4"><span class="toc-dot" data-section="78"></span><a href="#h-45-add-unit-tests-78" class="toc-link" data-section="78">5 Add unit tests</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="79"></span><a href="#h-watch-out-for-79" class="toc-link" data-section="79">Watch out for</a></li><li class="toc-item toc-l2"><span class="toc-dot" data-section="80"></span><a href="#h-milestone-5-migrate-packageslsp-80" class="toc-link" data-section="80">Milestone 5: Migrate packages/lsp</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="81"></span><a href="#h-goal-81" class="toc-link" data-section="81">Goal</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="82"></span><a href="#h-what-this-package-does-82" class="toc-link" data-section="82">What this package does</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="83"></span><a href="#h-verification-83" class="toc-link" data-section="83">Verification</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="84"></span><a href="#h-file-checklist-84" class="toc-link" data-section="84">File checklist</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="85"></span><a href="#h-steps-85" class="toc-link" data-section="85">Steps</a></li><li class="toc-item toc-l4"><span class="toc-dot" data-section="86"></span><a href="#h-51-copy-and-update-metadata-86" class="toc-link" data-section="86">1 Copy and update metadata</a></li><li class="toc-item toc-l4"><span class="toc-dot" data-section="87"></span><a href="#h-52-audit-cwd-usage-in-tool-wrapperts-87" class="toc-link" data-section="87">2 Audit cwd usage in tool-wrapper.ts</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="88"></span><a href="#h-watch-out-for-88" class="toc-link" data-section="88">Watch out for</a></li><li class="toc-item toc-l2"><span class="toc-dot" data-section="89"></span><a href="#h-milestone-6-create-packagessdk-89" class="toc-link" data-section="89">Milestone 6: Create packages/sdk</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="90"></span><a href="#h-goal-90" class="toc-link" data-section="90">Goal</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="91"></span><a href="#h-what-this-package-does-91" class="toc-link" data-section="91">What this package does</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="92"></span><a href="#h-verification-92" class="toc-link" data-section="92">Verification</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="93"></span><a href="#h-file-structure-93" class="toc-link" data-section="93">File structure</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="94"></span><a href="#h-steps-94" class="toc-link" data-section="94">Steps</a></li><li class="toc-item toc-l4"><span class="toc-dot" data-section="95"></span><a href="#h-61-create-the-package-skeleton-95" class="toc-link" data-section="95">1 Create the package skeleton</a></li><li class="toc-item toc-l4"><span class="toc-dot" data-section="96"></span><a href="#h-62-move-config-logic-into-sdk-96" class="toc-link" data-section="96">2 Move config logic into SDK</a></li><li class="toc-item toc-l4"><span class="toc-dot" data-section="97"></span><a href="#h-63-implement-the-sdk-agent-factory-97" class="toc-link" data-section="97">3 Implement the SDK agent factory</a></li><li class="toc-item toc-l4"><span class="toc-dot" data-section="98"></span><a href="#h-64-re-export-sdk-surface-98" class="toc-link" data-section="98">4 Re-export SDK surface</a></li><li class="toc-item toc-l4"><span class="toc-dot" data-section="99"></span><a href="#h-65-update-root-typecheck-script-99" class="toc-link" data-section="99">5 Update root typecheck script</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="100"></span><a href="#h-watch-out-for-100" class="toc-link" data-section="100">Watch out for</a></li><li class="toc-item toc-l2"><span class="toc-dot" data-section="101"></span><a href="#h-milestone-7-migrate-packagesopen-tui-if-keeping-the-cli-101" class="toc-link" data-section="101">Milestone 7: Migrate packages/open-tui (if keeping the CLI)</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="102"></span><a href="#h-goal-102" class="toc-link" data-section="102">Goal</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="103"></span><a href="#h-verification-103" class="toc-link" data-section="103">Verification</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="104"></span><a href="#h-file-checklist-104" class="toc-link" data-section="104">File checklist</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="105"></span><a href="#h-steps-105" class="toc-link" data-section="105">Steps</a></li><li class="toc-item toc-l4"><span class="toc-dot" data-section="106"></span><a href="#h-71-update-package-metadata-106" class="toc-link" data-section="106">1 Update package metadata</a></li><li class="toc-item toc-l4"><span class="toc-dot" data-section="107"></span><a href="#h-72-audit-combinedautocompleteprovider-107" class="toc-link" data-section="107">2 Audit CombinedAutocompleteProvider</a></li><li class="toc-item toc-l4"><span class="toc-dot" data-section="108"></span><a href="#h-73-rename-the-built-in-default-theme-108" class="toc-link" data-section="108">3 Rename the built-in default theme</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="109"></span><a href="#h-watch-out-for-109" class="toc-link" data-section="109">Watch out for</a></li><li class="toc-item toc-l2"><span class="toc-dot" data-section="110"></span><a href="#h-milestone-8-migrate-appscoding-agent-and-dogfood-sdk-110" class="toc-link" data-section="110">Milestone 8: Migrate apps/coding-agent and dogfood SDK</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="111"></span><a href="#h-goal-111" class="toc-link" data-section="111">Goal</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="112"></span><a href="#h-verification-112" class="toc-link" data-section="112">Verification</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="113"></span><a href="#h-file-checklist-113" class="toc-link" data-section="113">File checklist</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="114"></span><a href="#h-steps-114" class="toc-link" data-section="114">Steps</a></li><li class="toc-item toc-l4"><span class="toc-dot" data-section="115"></span><a href="#h-81-update-packagejson-115" class="toc-link" data-section="115">1 Update package.json</a></li><li class="toc-item toc-l4"><span class="toc-dot" data-section="116"></span><a href="#h-82-update-buildts-116" class="toc-link" data-section="116">2 Update build.ts</a></li><li class="toc-item toc-l4"><span class="toc-dot" data-section="117"></span><a href="#h-83-apply-rename-sweep-in-indexts-117" class="toc-link" data-section="117">3 Apply rename sweep in index.ts</a></li><li class="toc-item toc-l4"><span class="toc-dot" data-section="118"></span><a href="#h-84-update-profilerts-118" class="toc-link" data-section="118">4 Update profiler.ts</a></li><li class="toc-item toc-l4"><span class="toc-dot" data-section="119"></span><a href="#h-85-update-theme-namests-119" class="toc-link" data-section="119">5 Update theme-names.ts</a></li><li class="toc-item toc-l4"><span class="toc-dot" data-section="120"></span><a href="#h-86-update-hooksloaderts-120" class="toc-link" data-section="120">6 Update hooks/loader.ts</a></li><li class="toc-item toc-l4"><span class="toc-dot" data-section="121"></span><a href="#h-87-update-custom-toolsloaderts-121" class="toc-link" data-section="121">7 Update custom-tools/loader.ts</a></li><li class="toc-item toc-l4"><span class="toc-dot" data-section="122"></span><a href="#h-88-update-hookstypests-122" class="toc-link" data-section="122">8 Update hooks/types.ts</a></li><li class="toc-item toc-l4"><span class="toc-dot" data-section="123"></span><a href="#h-89-convert-configts-to-re-export-123" class="toc-link" data-section="123">9 Convert config.ts to re-export</a></li><li class="toc-item toc-l4"><span class="toc-dot" data-section="124"></span><a href="#h-810-update-headlessts-to-use-sdk-124" class="toc-link" data-section="124">10 Update headless.ts to use SDK</a></li><li class="toc-item toc-l4"><span class="toc-dot" data-section="125"></span><a href="#h-811-update-session-managerts-125" class="toc-link" data-section="125">11 Update session-manager.ts</a></li><li class="toc-item toc-l4"><span class="toc-dot" data-section="126"></span><a href="#h-812-update-examples-126" class="toc-link" data-section="126">12 Update examples</a></li><li class="toc-item toc-l4"><span class="toc-dot" data-section="127"></span><a href="#h-813-update-acpindexts-127" class="toc-link" data-section="127">13 Update acp/index.ts</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="128"></span><a href="#h-watch-out-for-128" class="toc-link" data-section="128">Watch out for</a></li><li class="toc-item toc-l2"><span class="toc-dot" data-section="129"></span><a href="#h-milestone-9-legacy-compatibility-optional-129" class="toc-link" data-section="129">Milestone 9: Legacy compatibility (removed)</a></li><li class="toc-item toc-l2"><span class="toc-dot" data-section="137"></span><a href="#h-testing-strategy-137" class="toc-link" data-section="137">Testing strategy</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="138"></span><a href="#h-package-level-checks-138" class="toc-link" data-section="138">Package-level checks</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="139"></span><a href="#h-sdk-manual-checks-139" class="toc-link" data-section="139">SDK manual checks</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="140"></span><a href="#h-cli-manual-checks-140" class="toc-link" data-section="140">CLI manual checks</a></li><li class="toc-item toc-l2"><span class="toc-dot" data-section="141"></span><a href="#h-troubleshooting-quick-hits-141" class="toc-link" data-section="141">Troubleshooting quick hits</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="142"></span><a href="#h-typescript-errors-142" class="toc-link" data-section="142">TypeScript Errors</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="143"></span><a href="#h-runtime-errors-143" class="toc-link" data-section="143">Runtime Errors</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="144"></span><a href="#h-build-errors-144" class="toc-link" data-section="144">Build Errors</a></li><li class="toc-item toc-l2"><span class="toc-dot" data-section="145"></span><a href="#h-beyond-the-basics-optional-enhancements-145" class="toc-link" data-section="145">Beyond the basics (optional enhancements)</a></li><li class="toc-item toc-l2"><span class="toc-dot" data-section="146"></span><a href="#h-quick-reference-146" class="toc-link" data-section="146">Quick reference</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="147"></span><a href="#h-commands-you-will-use-147" class="toc-link" data-section="147">Commands you will use</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="148"></span><a href="#h-files-you-will-touch-most-148" class="toc-link" data-section="148">Files you will touch most</a></li><li class="toc-item toc-l3"><span class="toc-dot" data-section="149"></span><a href="#h-useful-references-in-the-old-repo-149" class="toc-link" data-section="149">Useful references in the old repo</a></li></ul></nav>
<main class="content">
  <header class="doc-header">
    <h1 class="doc-title">SDK-Ready Merlin Migration Guide</h1>
    <div class="doc-info">
      <span>Dec 31, 2025</span>
      
      
      
    </div>
  </header>
  <article class="prose"><h1 id="h-sdk-ready-merlin-repo-migration-implementation-guide-1" data-section="1"><span class="section-num">1</span>SDK-ready merlin repo migration implementation guide</h1>

<blockquote>Purpose: Tutorial for rebuilding the project in a new repo, package by package, while making the codebase SDK-ready.
Time estimate: 16-24 hours of focused coding (spread over several sessions)
Difficulty: Advanced</blockquote>

<hr>

<h2 id="h-table-of-contents-2" data-section="2"><span class="section-num">2</span>Table of Contents</h2>

<ul>
<li><a href="#background-and-context" target="_blank" rel="noopener">Background and Context</a></li>
<li><a href="#milestone-0-migration-prep-and-guardrails" target="_blank" rel="noopener">Milestone 0: Migration Prep</a></li>
<li><a href="#milestone-1-root-infrastructure-in-the-new-repo" target="_blank" rel="noopener">Milestone 1: Root Infrastructure</a></li>
<li><a href="#milestone-2-migrate-packagesai" target="_blank" rel="noopener">Milestone 2: packages/ai</a></li>
<li><a href="#milestone-3-migrate-packagesagent" target="_blank" rel="noopener">Milestone 3: packages/agent</a></li>
<li><a href="#milestone-4-migrate-packagesbase-tools-and-make-tools-cwd-aware" target="_blank" rel="noopener">Milestone 4: packages/base-tools</a></li>
<li><a href="#milestone-5-migrate-packageslsp" target="_blank" rel="noopener">Milestone 5: packages/lsp</a></li>
<li><a href="#milestone-6-create-packagessdk" target="_blank" rel="noopener">Milestone 6: packages/sdk</a></li>
<li><a href="#milestone-7-migrate-packagesopen-tui-if-keeping-the-cli" target="_blank" rel="noopener">Milestone 7: packages/open-tui</a></li>
<li><a href="#milestone-8-migrate-appscoding-agent-and-dogfood-sdk" target="_blank" rel="noopener">Milestone 8: apps/coding-agent</a></li>
<li><a href="#milestone-9-legacy-compatibility-optional" target="_blank" rel="noopener">Milestone 9: Legacy Compatibility</a></li>
<li><a href="#testing-strategy" target="_blank" rel="noopener">Testing Strategy</a></li>
<li><a href="#troubleshooting-quick-hits" target="_blank" rel="noopener">Troubleshooting</a></li>
</ul>

<hr>

<h2 id="h-background-and-context-3" data-section="3"><span class="section-num">3</span>Background and context</h2>

<h3 id="h-why-we-are-doing-this-4" data-section="4"><span class="section-num">4</span>Why we are doing this</h3>

<ul>
<li>You want to learn the system deeply by rebuilding it section by section.</li>
<li>The current repo has tight coupling to <code>process.cwd()</code> and config paths, which blocks clean embedding.</li>
<li>The embedded SDK plan requires cwd-correct tools and reusable wiring outside the CLI app.</li>
<li>A clean-room repo migration is the best place to fix assumptions without destabilizing the existing repo.</li>
</ul>

<h3 id="h-naming-baseline-assumed-in-this-guide-5" data-section="5"><span class="section-num">5</span>Naming baseline (assumed in this guide)</h3>

<p>This guide assumes the new repo is merlin from day one. Use this mapping everywhere as you migrate:</p>

<div class="table-wrap"><table><thead><tr><th>Old</th><th>New</th></tr></thead><tbody><tr><td>Package scope: <code>@marvin-agents/<em></code></td><td><code>@merlin-agents/</em></code></td></tr><tr><td>CLI binary: <code>marvin</code></td><td><code>merlin</code></td></tr><tr><td>Config dir: <code>~/.config/marvin</code></td><td><code>~/.config/merlin</code></td></tr><tr><td>Codex cache: <code>~/.marvin/cache</code></td><td><code>~/.merlin/cache</code></td></tr><tr><td>Env vars: <code>MARVIN_<em></code></td><td><code>MERLIN_</em></code></td></tr><tr><td>Default theme: <code>marvin</code></td><td><code>merlin</code></td></tr><tr><td>Hook API parameter name in examples: <code>marvin</code></td><td><code>merlin</code></td></tr><tr><td>Repo name and URLs: <code>marvin</code></td><td><code>merlin</code></td></tr></tbody></table></div>

<h3 id="h-what-quotsdk-readyquot-means-here-6" data-section="6"><span class="section-num">6</span>What &quot;SDK-ready&quot; means here</h3>

<p>The goal is to make the core agent functionality usable as an embeddable library, not just a CLI tool. Specifically:</p>

<ol>
<li><strong>All default tools can be bound to a specific cwd</strong> (not implicitly <code>process.cwd()</code>).</li>
<li><strong>Config loading can target a specific cwd</strong> (for project AGENTS.md and CLAUDE.md).</li>
<li><strong>Transport wiring is reusable outside the CLI</strong> (no TUI or hook assumptions).</li>
<li><strong>The SDK does not auto-load hooks or custom tools</strong>; it accepts explicit tool lists.</li>
<li><strong>The CLI app becomes a consumer of the SDK</strong>, not the owner of wiring.</li>
</ol>

<h3 id="h-how-the-current-system-works-mental-model-7" data-section="7"><span class="section-num">7</span>How the current system works (mental model)</h3>

<h4 id="h-package-layering-8" data-section="8"><span class="section-num">8</span>Package layering</h4>

<p><figure class="code-block" data-listing="1"><div class="code-bar"><span class="code-lang">text</span><button class="code-copy">copy</button></div><pre><code>packages/ai         LLM types, models, providers, tool schemas
packages/agent      Agent state, transports, Codex OAuth, message lifecycle
packages/base-tools read/write/edit/bash tools
packages/lsp        LSP diagnostics wrapper for write/edit tools
packages/open-tui   TUI components and autocomplete
apps/coding-agent   CLI app: config, tools, hooks, TUI, sessions</code></pre></figure></p>

<h4 id="h-tool-pipeline-tui-and-headless-9" data-section="9"><span class="section-num">9</span>Tool pipeline (TUI and headless)</h4>

<p><figure class="code-block" data-listing="2"><div class="code-bar"><span class="code-lang">text</span><button class="code-copy">copy</button></div><pre><code>config  built-in tools + custom tools  hook wrapper  LSP wrapper  Agent</code></pre></figure></p>

<p>This ordering matters! The hook wrapper intercepts tool execution, and the LSP wrapper adds diagnostics <em>after</em> hooks run.</p>

<h4 id="h-mode-entrypoints-10" data-section="10"><span class="section-num">10</span>Mode entrypoints</h4>

<p>The CLI has three modes:<br><ul><br><li><strong>TUI</strong>: <code>apps/coding-agent/src/tui-app.tsx</code> (full interactive experience)</li><br><li><strong>Headless</strong>: <code>apps/coding-agent/src/headless.ts</code> (single prompt, JSON output)</li><br><li><strong>ACP</strong>: <code>apps/coding-agent/src/acp/index.ts</code> (Zed editor integration)</li><br></ul></p>

<h4 id="h-key-coupling-issues-to-remove-for-sdk-readiness-11" data-section="11"><span class="section-num">11</span>Key coupling issues to remove for SDK readiness</h4>

<ol>
<li><strong><code>process.cwd()</code> used implicitly</strong> - Tools use <code>path.resolve()</code> which defaults to process.cwd()</li>
<li><strong>Hardcoded config paths</strong> - <code>~/.config/marvin</code> baked into multiple files</li>
<li><strong>Cache paths hardcoded</strong> - <code>~/.marvin/cache</code> for Codex instructions</li>
<li><strong>Session storage paths</strong> - Based on process.cwd() at construction time</li>
</ol>

<hr>

<h2 id="h-key-files-to-understand-read-these-in-the-old-repo-12" data-section="12"><span class="section-num">12</span>Key files to understand (read these in the old repo)</h2>

<h3 id="h-core-files-quick-reference-13" data-section="13"><span class="section-num">13</span>Core Files - Quick Reference</h3>

<div class="table-wrap"><table><thead><tr><th>File</th><th>Purpose</th><th>Why it matters</th></tr></thead><tbody><tr><td><code>apps/coding-agent/src/index.ts</code></td><td>CLI entrypoint, mode dispatch, TUI worker path</td><td>Understand how modes are wired</td></tr><tr><td><code>apps/coding-agent/src/tui-app.tsx</code></td><td>TUI wiring and tool pipeline</td><td>Source of most coupling</td></tr><tr><td><code>apps/coding-agent/src/headless.ts</code></td><td>Headless wiring</td><td>SDK wiring reference</td></tr><tr><td><code>apps/coding-agent/src/acp/index.ts</code></td><td>ACP server</td><td>Optional migration path</td></tr><tr><td><code>apps/coding-agent/src/config.ts</code></td><td>Config + AGENTS.md merge</td><td>Needs cwd awareness</td></tr><tr><td><code>apps/coding-agent/src/session-manager.ts</code></td><td>Session storage</td><td>Has cwd and config path assumptions</td></tr><tr><td><code>apps/coding-agent/src/hooks/<em></code></td><td>Hooks system</td><td>Hook lifecycle and tool wrapping</td></tr><tr><td><code>apps/coding-agent/src/hooks/types.ts</code></td><td>Hook API types</td><td>Rename hook parameter + docs</td></tr><tr><td><code>apps/coding-agent/src/custom-tools/</em></code></td><td>Custom tools loader</td><td>API exposed to user tools</td></tr><tr><td><code>apps/coding-agent/src/profiler.ts</code></td><td>Profiler env var</td><td>Rename <code>MARVIN_<em></code>  <code>MERLIN_</em></code></td></tr><tr><td><code>apps/coding-agent/src/theme-names.ts</code></td><td>Theme list</td><td>Default theme rename</td></tr><tr><td><code>packages/open-tui/src/context/theme.tsx</code></td><td>Built-in theme</td><td>Default theme rename</td></tr><tr><td><code>packages/base-tools/src/tools/<em></code></td><td>read/write/edit/bash</td><td>Must become cwd aware</td></tr><tr><td><code>packages/base-tools/src/tools/path-utils.ts</code></td><td>path resolution</td><td>Core for cwd binding</td></tr><tr><td><code>packages/lsp/src/tool-wrapper.ts</code></td><td>LSP wrapper</td><td>Must respect cwd and tool interfaces</td></tr><tr><td><code>packages/agent/src/transports/CodexTransport.ts</code></td><td>Codex transport</td><td>Uses instructions cache</td></tr><tr><td><code>packages/agent/src/transports/codex/instructions.ts</code></td><td>Codex cache</td><td>Uses HOME path</td></tr><tr><td><code>packages/agent/src/codex-auth-cli.ts</code></td><td>Codex token store</td><td>Default config dir + legacy migration</td></tr><tr><td><code>packages/open-tui/src/autocomplete/autocomplete.ts</code></td><td>Autocomplete basePath</td><td>Defaults to process.cwd()</td></tr><tr><td><code>apps/coding-agent/scripts/build.ts</code></td><td>CLI binary build</td><td>Requires Solid plugin</td></tr><tr><td><code>package.json</code></td><td>Root scripts/workspaces</td><td>Must match new repo structure</td></tr><tr><td><code>bunfig.toml</code></td><td>Test preload</td><td>Required for tests</td></tr><tr><td><code>scripts/test-all.ts</code></td><td>Test runner</td><td>Standard test orchestration</td></tr></tbody></table></div>

<h3 id="h-deep-dive-packagesbase-tools-14" data-section="14"><span class="section-num">14</span>Deep Dive: packages/base-tools</h3>

<p>The base-tools package contains the core file manipulation tools. Here's how they currently work:</p>

<h4 id="h-path-utilsts-current-implementation-15" data-section="15"><span class="section-num">15</span>path-utils.ts - Current Implementation</h4>

<p><figure class="code-block" data-listing="3"><div class="code-bar"><span class="code-lang">typescript</span><button class="code-copy">copy</button></div><pre class="language-typescript"><code class="language-typescript">// packages/base-tools/src/tools/path-utils.ts
import { accessSync, constants } from &quot;node:fs&quot;;
import * as os from &quot;node:os&quot;;

// Handles unicode spaces that can appear in file paths (e.g., from macOS screenshots)
const UNICODE_SPACES = /[\u00A0\u2000-\u200A\u202F\u205F\u3000]/g;
const NARROW_NO_BREAK_SPACE = &quot;\u202F&quot;;

function normalizeUnicodeSpaces(str: string): string {
  return str.replace(UNICODE_SPACES, &quot; &quot;);
}

// macOS screenshots have weird AM/PM spacing - this fixes that
function tryMacOSScreenshotPath(filePath: string): string {
  return filePath.replace(/ (AM|PM)\./g, `${NARROW_NO_BREAK_SPACE}$1.`);
}

function fileExists(filePath: string): boolean {
  try {
    accessSync(filePath, constants.F_OK);
    return true;
  } catch {
    return false;
  }
}

// Expands ~ to home directory
export function expandPath(filePath: string): string {
  const normalized = normalizeUnicodeSpaces(filePath);
  if (normalized === &quot;~&quot;) {
    return os.homedir();
  }
  if (normalized.startsWith(&quot;~/&quot;)) {
    return os.homedir() + normalized.slice(1);
  }
  return normalized;
}

// For read operations: tries the literal path first, then macOS variant
export function resolveReadPath(filePath: string): string {
  const expanded = expandPath(filePath);

  if (fileExists(expanded)) {
    return expanded;
  }

  const macOSVariant = tryMacOSScreenshotPath(expanded);
  if (macOSVariant !== expanded &amp;&amp; fileExists(macOSVariant)) {
    return macOSVariant;
  }

  return expanded;
}</code></pre></figure></p>

<strong>Problem:</strong> This file only handles tilde expansion. When tools call <code>path.resolve(expandPath(path))</code>, the <code>path.resolve()</code> uses <code>process.cwd()</code> implicitly for relative paths.

<h4 id="h-readts-current-implementation-16" data-section="16"><span class="section-num">16</span>read.ts - Current Implementation</h4>

<p><figure class="code-block" data-listing="4"><div class="code-bar"><span class="code-lang">typescript</span><button class="code-copy">copy</button></div><pre class="language-typescript"><code class="language-typescript">// packages/base-tools/src/tools/read.ts (simplified)
import { resolve as resolvePath } from &quot;path&quot;;
import { resolveReadPath } from &quot;./path-utils.js&quot;;

// ... schema definition ...

export const readTool: AgentTool&lt;typeof schema, ReadDetails&gt; = {
  name: &quot;read&quot;,
  label: &quot;read&quot;,
  description: &quot;Read the contents of a file...&quot;,
  parameters: schema,
  execute: async (_toolCallId, params, signal) =&gt; {
    const { path, offset, limit } = params;
    
    // THE PROBLEM: resolvePath uses process.cwd() implicitly!
    const absolutePath = resolvePath(resolveReadPath(path));
    
    // ... rest of implementation
  },
};</code></pre></figure></p>

<h4 id="h-bashts-current-implementation-17" data-section="17"><span class="section-num">17</span>bash.ts - Current Implementation</h4>

<p><figure class="code-block" data-listing="5"><div class="code-bar"><span class="code-lang">typescript</span><button class="code-copy">copy</button></div><pre class="language-typescript"><code class="language-typescript">// packages/base-tools/src/tools/bash.ts (simplified)
import { spawn } from &quot;child_process&quot;;
import { getShellConfig } from &quot;../utils/shell.js&quot;;

export const bashTool: AgentTool&lt;typeof schema, BashDetails&gt; = {
  name: &quot;bash&quot;,
  label: &quot;bash&quot;,
  description: &quot;Execute a bash command in the current working directory...&quot;,
  parameters: schema,
  execute: async (_toolCallId, params, signal) =&gt; {
    const { command, timeout } = params;
    
    const { shell, args } = getShellConfig();
    // THE PROBLEM: No cwd option - inherits from parent process!
    const child = spawn(shell, [...args, command], {
      detached: true,
      stdio: [&quot;ignore&quot;, &quot;pipe&quot;, &quot;pipe&quot;],
    });
    
    // ... rest of implementation
  },
};</code></pre></figure></p>

<h3 id="h-deep-dive-appscoding-agentsrcconfigts-18" data-section="18"><span class="section-num">18</span>Deep Dive: apps/coding-agent/src/config.ts</h3>

<p>This file handles loading configuration and merging AGENTS.md files:</p>

<p><figure class="code-block" data-listing="6"><div class="code-bar"><span class="code-lang">typescript</span><button class="code-copy">copy</button></div><pre class="language-typescript"><code class="language-typescript">// apps/coding-agent/src/config.ts (key parts)
import * as path from &quot;path&quot;;
import * as os from &quot;os&quot;;

// GLOBAL paths - searched in order, first found wins
const GLOBAL_AGENTS_PATHS = [
  () =&gt; path.join(os.homedir(), '.config', 'marvin', 'agents.md'),
  () =&gt; path.join(os.homedir(), '.codex', 'agents.md'),
  () =&gt; path.join(os.homedir(), '.claude', 'CLAUDE.md'),
];

// PROJECT paths - PROBLEM: Uses process.cwd() directly!
const PROJECT_AGENTS_PATHS = [
  () =&gt; path.join(process.cwd(), 'AGENTS.md'),
  () =&gt; path.join(process.cwd(), 'CLAUDE.md'),
];

// Default config directory - hardcoded!
const resolveConfigDir = (): string =&gt; path.join(os.homedir(), '.config', 'marvin');

// Loads first existing file from a list of path functions
const loadFirstExisting = async (pathFns: Array&lt;() =&gt; string&gt;): Promise&lt;{ path: string; content: string } | undefined&gt; =&gt; {
  for (const pathFn of pathFns) {
    const p = pathFn();
    const content = await readFileIfExists(p);
    if (content !== undefined) {
      return { path: p, content };
    }
  }
  return undefined;
};

// Merges global and project AGENTS.md files
export const loadAgentsConfig = async (): Promise&lt;AgentsConfig&gt; =&gt; {
  const global = await loadFirstExisting(GLOBAL_AGENTS_PATHS);
  const project = await loadFirstExisting(PROJECT_AGENTS_PATHS);

  const parts: string[] = [];
  if (global) parts.push(global.content);
  if (project) parts.push(project.content);

  return {
    global,
    project,
    combined: parts.join('\n\n---\n\n'),
  };
};

// Main config loader
export const loadAppConfig = async (options?: {
  configDir?: string;
  configPath?: string;
  provider?: string;
  model?: string;
  thinking?: ThinkingLevel;
}): Promise&lt;LoadedAppConfig&gt; =&gt; {
  const configDir = options?.configDir ?? resolveConfigDir();
  const configPath = options?.configPath ?? path.join(configDir, 'config.json');

  // ... load config.json ...
  
  // Merge AGENTS.md content into system prompt
  const agentsConfig = await loadAgentsConfig();
  
  const systemPrompt = agentsConfig.combined
    ? `${basePrompt}\n\n${agentsConfig.combined}`
    : basePrompt;

  return { 
    provider, modelId, model, thinking, 
    theme: theme ?? 'marvin',  // Default theme name
    systemPrompt, agentsConfig, configDir, configPath, 
    // ... 
  };
};</code></pre></figure></p>

<strong>Problems to fix:</strong>
<ol>
<li><code>PROJECT_AGENTS_PATHS</code> uses <code>process.cwd()</code> directly</li>
<li><code>resolveConfigDir</code> returns hardcoded <code>~/.config/marvin</code></li>
<li>Default theme is <code>'marvin'</code></li>
</ol>

<h3 id="h-deep-dive-codex-instructions-cache-19" data-section="19"><span class="section-num">19</span>Deep Dive: Codex Instructions Cache</h3>

<p><figure class="code-block" data-listing="7"><div class="code-bar"><span class="code-lang">typescript</span><button class="code-copy">copy</button></div><pre class="language-typescript"><code class="language-typescript">// packages/agent/src/transports/codex/instructions.ts
import { join } from &quot;path&quot;;
import { existsSync, mkdirSync, readFileSync, writeFileSync } from &quot;fs&quot;;

// PROBLEM: Hardcoded cache directory!
const CACHE_DIR = join(process.env.HOME || &quot;&quot;, &quot;.marvin&quot;, &quot;cache&quot;);
const CACHE_TTL_MS = 15 * 60 * 1000; // 15 minutes

type ModelFamily = &quot;gpt-5.2-codex&quot; | &quot;gpt-5.2&quot;;

const PROMPT_FILES: Record&lt;ModelFamily, string&gt; = {
  &quot;gpt-5.2-codex&quot;: &quot;gpt-5.2-codex_prompt.md&quot;,
  &quot;gpt-5.2&quot;: &quot;gpt_5_2_prompt.md&quot;,
};

function getCacheFiles(family: ModelFamily) {
  return {
    cache: join(CACHE_DIR, `codex-instructions-${family}.md`),
    meta: join(CACHE_DIR, `codex-instructions-${family}-meta.json`),
  };
}

export async function getCodexInstructions(model: string): Promise&lt;string&gt; {
  const family = getModelFamily(model);
  const { cache: CACHE_FILE, meta: CACHE_META_FILE } = getCacheFiles(family);

  try {
    // Check if cached and TTL valid
    if (existsSync(CACHE_META_FILE) &amp;&amp; existsSync(CACHE_FILE)) {
      const meta = JSON.parse(readFileSync(CACHE_META_FILE, &quot;utf-8&quot;));
      if (Date.now() - meta.lastChecked &lt; CACHE_TTL_MS) {
        return readFileSync(CACHE_FILE, &quot;utf-8&quot;);
      }
    }

    // Fetch from GitHub...
    const tag = await getLatestReleaseTag();
    const url = `https://raw.githubusercontent.com/openai/codex/${tag}/codex-rs/core/${PROMPT_FILES[family]}`;
    
    // ... fetch and cache ...
  } catch (err) {
    // Fallback: return stale cache if available
    if (existsSync(CACHE_FILE)) {
      return readFileSync(CACHE_FILE, &quot;utf-8&quot;);
    }
    throw err;
  }
}</code></pre></figure></p>

<h3 id="h-deep-dive-token-storage-20" data-section="20"><span class="section-num">20</span>Deep Dive: Token Storage</h3>

<p><figure class="code-block" data-listing="8"><div class="code-bar"><span class="code-lang">typescript</span><button class="code-copy">copy</button></div><pre class="language-typescript"><code class="language-typescript">// packages/agent/src/codex-auth-cli.ts
import { homedir } from &quot;os&quot;;
import { join } from &quot;path&quot;;

// PROBLEM: Hardcoded config directories!
const DEFAULT_CONFIG_DIR = join(homedir(), &quot;.config&quot;, &quot;marvin&quot;);
const LEGACY_CONFIG_DIR = join(homedir(), &quot;.marvin&quot;);

export interface TokenStoreOptions {
  configDir?: string;
  tokensFile?: string;
}

function resolveTokensFile(options?: TokenStoreOptions): string {
  if (options?.tokensFile) return options.tokensFile;
  const configDir = options?.configDir ?? DEFAULT_CONFIG_DIR;
  return join(configDir, &quot;codex-tokens.json&quot;);
}

// Loads tokens with legacy migration
export function loadTokens(options?: TokenStoreOptions): CodexTokens | null {
  const tokensFile = resolveTokensFile(options);
  
  try {
    const data = readFileSync(tokensFile, &quot;utf-8&quot;);
    return JSON.parse(data);
  } catch {
    // Try legacy location
  }

  const legacyFile = join(LEGACY_CONFIG_DIR, &quot;codex-tokens.json&quot;);
  try {
    const data = readFileSync(legacyFile, &quot;utf-8&quot;);
    const tokens = JSON.parse(data);
    
    // Migrate: save to new location, delete old
    saveTokens(tokens, { configDir: DEFAULT_CONFIG_DIR });
    unlinkSync(legacyFile);
    
    return tokens;
  } catch {
    return null;
  }
}</code></pre></figure></p>

<h3 id="h-deep-dive-session-manager-21" data-section="21"><span class="section-num">21</span>Deep Dive: Session Manager</h3>

<p><figure class="code-block" data-listing="9"><div class="code-bar"><span class="code-lang">typescript</span><button class="code-copy">copy</button></div><pre class="language-typescript"><code class="language-typescript">// apps/coding-agent/src/session-manager.ts
import { join } from &quot;path&quot;;

// Converts /path/to/project  --path--to--project--
const safeCwd = (cwd: string): string =&gt; {
  return '--' + cwd.replace(/\//g, '--') + '--';
};

export class SessionManager {
  private configDir: string;
  private cwd: string;
  private sessionDir: string;

  // PROBLEM: Captures process.cwd() at construction time!
  constructor(configDir: string = join(process.env.HOME || '', '.config', 'marvin')) {
    this.configDir = configDir;
    this.cwd = process.cwd();  // &lt;-- This is the issue
    this.sessionDir = join(configDir, 'sessions', safeCwd(this.cwd));
  }

  startSession(provider: string, modelId: string, thinkingLevel: ThinkingLevel): string {
    this.ensureDir();
    
    const id = randomUUID();
    const timestamp = Date.now();
    const filename = `${timestamp}_${id}.jsonl`;
    this.currentSessionPath = join(this.sessionDir, filename);
    
    // First line is metadata
    const metadata: SessionMetadata = {
      type: 'session',
      id,
      timestamp,
      cwd: this.cwd,
      provider,
      modelId,
      thinkingLevel,
    };
    
    writeFileSync(this.currentSessionPath, JSON.stringify(metadata) + '\n');
    return id;
  }

  // Appends messages as JSONL entries
  appendMessage(message: AppMessage): void {
    if (!this.currentSessionPath) return;

    const entry: SessionMessageEntry = {
      type: 'message',
      timestamp: Date.now(),
      message,
    };

    // Fire-and-forget async write
    appendFile(this.currentSessionPath, JSON.stringify(entry) + '\n', (err) =&gt; {
      if (err) console.error('Session write error:', err.message);
    });
  }
}</code></pre></figure></p>

<strong>Session file structure:</strong>
<figure class="code-block" data-listing="10"><div class="code-bar"><span class="code-lang">text</span><button class="code-copy">copy</button></div><pre><code>~/.config/marvin/sessions/--Users--me--myproject--/
  1735689600000_abc123.jsonl   &lt;- Each file is one session
  1735689700000_def456.jsonl</code></pre></figure>

<strong>JSONL format:</strong>
<figure class="code-block" data-listing="11"><div class="code-bar"><span class="code-lang">jsonl</span><button class="code-copy">copy</button></div><pre class="language-jsonl"><code class="language-jsonl">{&quot;type&quot;:&quot;session&quot;,&quot;id&quot;:&quot;abc123&quot;,&quot;timestamp&quot;:1735689600000,&quot;cwd&quot;:&quot;/Users/me/myproject&quot;,...}
{&quot;type&quot;:&quot;message&quot;,&quot;timestamp&quot;:1735689601000,&quot;message&quot;:{&quot;role&quot;:&quot;user&quot;,&quot;content&quot;:&quot;Hello&quot;}}
{&quot;type&quot;:&quot;message&quot;,&quot;timestamp&quot;:1735689602000,&quot;message&quot;:{&quot;role&quot;:&quot;assistant&quot;,&quot;content&quot;:&quot;Hi!&quot;}}</code></pre></figure>

<hr>

<h2 id="h-patterns-to-follow-22" data-section="22"><span class="section-num">22</span>Patterns to follow</h2>

<h3 id="h-agenttool-pattern-schema-execute-abort-handling-23" data-section="23"><span class="section-num">23</span>AgentTool pattern (schema + execute + abort handling)</h3>

<p>Every tool follows this structure:</p>

<p><figure class="code-block" data-listing="12"><div class="code-bar"><span class="code-lang">typescript</span><button class="code-copy">copy</button></div><pre class="language-typescript"><code class="language-typescript">import type { AgentTool } from &quot;@merlin-agents/ai&quot;;
import { Type } from &quot;@sinclair/typebox&quot;;

// 1. Define the parameter schema using TypeBox
const schema = Type.Object({
  input: Type.String({ description: &quot;Example input&quot; })
});

// 2. Define a type for the details returned (for UI rendering)
type ExampleDetails = { note: string | null };

// 3. Export the tool object
export const exampleTool: AgentTool&lt;typeof schema, ExampleDetails&gt; = {
  name: &quot;example&quot;,          // Unique identifier
  label: &quot;example&quot;,         // Display name in TUI
  description: &quot;Demonstrates tool shape&quot;,  // Shown to LLM
  parameters: schema,
  execute: async (_toolCallId, params, signal) =&gt; {
    // Always check abort signal first
    if (signal?.aborted) throw new Error(&quot;aborted&quot;);
    
    const text = params.input;
    
    // Return format is always { content, details }
    return { 
      content: [{ type: &quot;text&quot;, text }], 
      details: { note: null } 
    };
  },
};</code></pre></figure></p>

<h3 id="h-hook-wiring-pattern-register-events-call-send-24" data-section="24"><span class="section-num">24</span>Hook wiring pattern (register events, call send)</h3>

<p>Hooks are user-defined plugins that can observe and intercept agent behavior:</p>

<p><figure class="code-block" data-listing="13"><div class="code-bar"><span class="code-lang">typescript</span><button class="code-copy">copy</button></div><pre class="language-typescript"><code class="language-typescript">import type { HookFactory } from &quot;@merlin-agents/coding-agent/hooks&quot;;

// Default export is a factory function that receives the API
const hook: HookFactory = (merlin) =&gt; {
  // Register handlers for events
  merlin.on(&quot;agent.start&quot;, () =&gt; {
    // Use send() to inject messages into the conversation
    merlin.send(&quot;Starting a new agent turn&quot;);
  });
  
  // Can also intercept tool execution
  merlin.on(&quot;tool.execute.before&quot;, (event, ctx) =&gt; {
    console.log(`About to run ${event.toolName}`);
    // Return { block: true, reason: &quot;...&quot; } to prevent execution
  });
};

export default hook;</code></pre></figure></p>

<strong>Available events:</strong>
<ul>
<li><code>app.start</code> - CLI started</li>
<li><code>session.start</code>, <code>session.resume</code>, <code>session.clear</code> - Session lifecycle</li>
<li><code>agent.start</code>, <code>agent.end</code> - Agent turn lifecycle</li>
<li><code>turn.start</code>, <code>turn.end</code> - Per-turn lifecycle (includes token usage)</li>
<li><code>tool.execute.before</code> - Before tool runs (can block)</li>
<li><code>tool.execute.after</code> - After tool runs (can modify result)</li>
</ul>

<h3 id="h-transport-composition-pattern-25" data-section="25"><span class="section-num">25</span>Transport composition pattern</h3>

<p>Transports handle communication with LLM providers:</p>

<p><figure class="code-block" data-listing="14"><div class="code-bar"><span class="code-lang">typescript</span><button class="code-copy">copy</button></div><pre class="language-typescript"><code class="language-typescript">import { ProviderTransport, CodexTransport, RouterTransport } from &quot;@merlin-agents/agent-core&quot;;

// Provider transport: handles Anthropic, OpenAI, Google, etc.
const providerTransport = new ProviderTransport({ 
  getApiKey: async (provider) =&gt; getApiKeyForProvider(provider) 
});

// Codex transport: handles OpenAI Codex with OAuth
const codexTransport = new CodexTransport({ 
  getTokens: async () =&gt; loadTokens({ configDir }), 
  setTokens: async (tokens) =&gt; saveTokens(tokens, { configDir }),
  clearTokens: async () =&gt; clearTokens({ configDir }),
});

// Router transport: routes requests based on model.provider
const transport = new RouterTransport({ 
  provider: providerTransport, 
  codex: codexTransport 
});

// When model.provider === &quot;codex&quot;, uses codexTransport
// Otherwise, uses providerTransport</code></pre></figure></p>

<hr>

<h2 id="h-milestone-0-migration-prep-and-guardrails-26" data-section="26"><span class="section-num">26</span>Milestone 0: Migration prep and guardrails</h2>

<h3 id="h-goal-27" data-section="27"><span class="section-num">27</span>Goal</h3>

<p>Define the new repo boundaries, naming, and the order of migration. Set up a repeatable audit process so every file you migrate is understood.</p>

<h3 id="h-verification-28" data-section="28"><span class="section-num">28</span>Verification</h3>

<li class="task"><span class="checkbox">[ ]</span> You have a new empty repo created and a working copy of the old repo open side by side.</li>
<li class="task"><span class="checkbox">[ ]</span> You can run <code>rg</code> and <code>bun</code> in both repos.</li>

<h3 id="h-steps-29" data-section="29"><span class="section-num">29</span>Steps</h3>

<h4 id="h-01-lock-naming-baseline-merlin-from-day-one-30" data-section="30"><span class="section-num">30</span>0.1 Lock naming baseline (merlin from day one)</h4>

<p>Create a file <code>NAMING.md</code> in the new repo root:</p>

<p><figure class="code-block" data-listing="15"><div class="code-bar"><span class="code-lang">markdown</span><button class="code-copy">copy</button></div><pre class="language-markdown"><code class="language-markdown"># Naming Conventions

## Package Scope
All packages use `@merlin-agents/*` scope.

## CLI Binary
The CLI is named `merlin`.

## Config Directory
Default config: `~/.config/merlin`
Legacy (for migration): `~/.config/marvin`, `~/.marvin`

## Cache Directory  
Default cache: `~/.merlin/cache`
Legacy: `~/.marvin/cache`

## Environment Variables
All env vars use `MERLIN_` prefix.

## Theme
Default theme is named `merlin`.</code></pre></figure></p>

<h4 id="h-02-freeze-the-baseline-31" data-section="31"><span class="section-num">31</span>0.2 Freeze the baseline</h4>

<p>In the old repo, record the current state:</p>

<p><figure class="code-block" data-listing="16"><div class="code-bar"><span class="code-lang">bash</span><button class="code-copy">copy</button></div><pre class="language-bash"><code class="language-bash"># Record current package versions
cat package.json | jq '{name, version, workspaces, scripts}' &gt; ~/baseline-root.json

# Record all package.json files
for pkg in packages/*/package.json apps/*/package.json; do
  echo &quot;=== $pkg ===&quot; &gt;&gt; ~/baseline-packages.txt
  cat $pkg | jq '{name, version, dependencies, devDependencies}' &gt;&gt; ~/baseline-packages.txt
done</code></pre></figure></p>

<h4 id="h-03-create-an-audit-checklist-32" data-section="32"><span class="section-num">32</span>0.3 Create an audit checklist</h4>

<p>Create a tracking document (e.g., <code>MIGRATION-STATUS.md</code>):</p>

<p><figure class="code-block" data-listing="17"><div class="code-bar"><span class="code-lang">markdown</span><button class="code-copy">copy</button></div><pre class="language-markdown"><code class="language-markdown"># Migration Status

## Milestone 1: Root Infrastructure
- [ ] package.json
- [ ] bunfig.toml
- [ ] tsconfig.base.json
- [ ] test/setup.ts
- [ ] scripts/test-all.ts
- [ ] .gitignore

## Milestone 2: packages/ai
- [ ] package.json
- [ ] src/index.ts
- [ ] src/agent/types.ts
- [ ] src/models.generated.ts
- [ ] scripts/generate-models.ts

## Milestone 3: packages/agent
...</code></pre></figure></p>

<h3 id="h-watch-out-for-33" data-section="33"><span class="section-num">33</span>Watch out for</h3>

<ul>
<li>Renaming at the same time as refactoring can hide behavioral changes.</li>
<li>Changing public APIs without a compatibility plan can complicate later publishing.</li>
<li>Keep a terminal open in the old repo to reference code as you work.</li>
</ul>

<hr>

<h2 id="h-milestone-1-root-infrastructure-in-the-new-repo-34" data-section="34"><span class="section-num">34</span>Milestone 1: Root infrastructure in the new repo</h2>

<h3 id="h-goal-35" data-section="35"><span class="section-num">35</span>Goal</h3>

<p>Replicate the workspace tooling so packages can be dropped in one at a time.</p>

<h3 id="h-verification-36" data-section="36"><span class="section-num">36</span>Verification</h3>

<li class="task"><span class="checkbox">[ ]</span> <code>bun install</code> succeeds in the new repo.</li>
<li class="task"><span class="checkbox">[ ]</span> <code>bun scripts/test-all.ts</code> runs (may say &quot;No workspaces found&quot; initially).</li>

<h3 id="h-file-checklist-37" data-section="37"><span class="section-num">37</span>File checklist</h3>

<p>Copy and review each file from the old repo:</p>

<ol>
<li><code>package.json</code></li>
<li><code>bunfig.toml</code></li>
<li><code>tsconfig.base.json</code></li>
<li><code>test/setup.ts</code></li>
<li><code>scripts/test-all.ts</code></li>
<li><code>.gitignore</code></li>
</ol>

<h3 id="h-steps-38" data-section="38"><span class="section-num">38</span>Steps</h3>

<h4 id="h-11-copy-root-packagejson-39" data-section="39"><span class="section-num">39</span>1.1 Copy root <code>package.json</code></h4>

<p>Create <code>package.json</code> in the new repo:</p>

<p><figure class="code-block" data-listing="18"><div class="code-bar"><span class="code-lang">json</span><button class="code-copy">copy</button></div><pre class="language-json"><code class="language-json">{
  &quot;name&quot;: &quot;merlin-agent&quot;,
  &quot;private&quot;: true,
  &quot;type&quot;: &quot;module&quot;,
  &quot;workspaces&quot;: [
    &quot;packages/*&quot;,
    &quot;apps/*&quot;
  ],
  &quot;scripts&quot;: {
    &quot;typecheck&quot;: &quot;bun run --filter '*' typecheck&quot;,
    &quot;test&quot;: &quot;bun run scripts/test-all.ts&quot;,
    &quot;merlin&quot;: &quot;bun apps/coding-agent/src/index.ts&quot;
  },
  &quot;devDependencies&quot;: {
    &quot;@sinclair/typebox&quot;: &quot;^0.34.33&quot;,
    &quot;typescript&quot;: &quot;^5.8.3&quot;
  },
  &quot;overrides&quot;: {
    &quot;solid-js&quot;: &quot;1.9.5&quot;,
    &quot;babel-preset-solid&quot;: &quot;1.9.5&quot;
  }
}</code></pre></figure></p>

<strong>Key changes from old:</strong>
<ul>
<li><code>name</code> is now <code>merlin-agent</code> (was <code>marvin-agent</code>)</li>
<li><code>scripts.merlin</code> replaces <code>scripts.marvin</code></li>
<li>Keep the <code>overrides</code> for solid-js version pinning (TUI requires specific version)</li>
</ul>

<h4 id="h-12-copy-bunfigtoml-40" data-section="40"><span class="section-num">40</span>1.2 Copy <code>bunfig.toml</code></h4>

<p><figure class="code-block" data-listing="19"><div class="code-bar"><span class="code-lang">toml</span><button class="code-copy">copy</button></div><pre class="language-toml"><code class="language-toml">[test]
preload = [&quot;./test/setup.ts&quot;]</code></pre></figure></p>

<p>This ensures the test setup runs before all tests.</p>

<h4 id="h-13-copy-tsconfigbasejson-41" data-section="41"><span class="section-num">41</span>1.3 Copy <code>tsconfig.base.json</code></h4>

<p>This is the shared TypeScript config that all packages extend:</p>

<p><figure class="code-block" data-listing="20"><div class="code-bar"><span class="code-lang">json</span><button class="code-copy">copy</button></div><pre class="language-json"><code class="language-json">{
  &quot;compilerOptions&quot;: {
    &quot;target&quot;: &quot;ES2022&quot;,
    &quot;module&quot;: &quot;ESNext&quot;,
    &quot;moduleResolution&quot;: &quot;bundler&quot;,
    &quot;esModuleInterop&quot;: true,
    &quot;strict&quot;: true,
    &quot;skipLibCheck&quot;: true,
    &quot;noEmit&quot;: true,
    &quot;resolveJsonModule&quot;: true,
    &quot;isolatedModules&quot;: true,
    &quot;jsx&quot;: &quot;preserve&quot;,
    &quot;jsxImportSource&quot;: &quot;solid-js&quot;,
    &quot;lib&quot;: [&quot;ES2022&quot;, &quot;DOM&quot;],
    &quot;types&quot;: [&quot;bun-types&quot;]
  }
}</code></pre></figure></p>

<p>Don't change this yet - it matches the old repo's build settings.</p>

<h4 id="h-14-copy-testsetupts-42" data-section="42"><span class="section-num">42</span>1.4 Copy <code>test/setup.ts</code></h4>

<p><figure class="code-block" data-listing="21"><div class="code-bar"><span class="code-lang">typescript</span><button class="code-copy">copy</button></div><pre class="language-typescript"><code class="language-typescript">// test/setup.ts
// Disable colors in test output for consistent snapshots
process.env.NO_COLOR = &quot;1&quot;;

// Limit stack traces for cleaner test output
Error.stackTraceLimit = 10;</code></pre></figure></p>

<h4 id="h-15-copy-scriptstest-allts-43" data-section="43"><span class="section-num">43</span>1.5 Copy <code>scripts/test-all.ts</code></h4>

<p>This script runs tests across all packages:</p>

<p><figure class="code-block" data-listing="22"><div class="code-bar"><span class="code-lang">typescript</span><button class="code-copy">copy</button></div><pre class="language-typescript"><code class="language-typescript">#!/usr/bin/env bun
import { $ } from &quot;bun&quot;;
import { readdirSync, existsSync } from &quot;node:fs&quot;;
import { join } from &quot;node:path&quot;;

const packagesDir = join(import.meta.dir, &quot;..&quot;, &quot;packages&quot;);
const appsDir = join(import.meta.dir, &quot;..&quot;, &quot;apps&quot;);

async function runTests() {
  const dirs = [
    ...readdirSync(packagesDir).map(d =&gt; join(packagesDir, d)),
    ...readdirSync(appsDir).map(d =&gt; join(appsDir, d)),
  ].filter(d =&gt; existsSync(join(d, &quot;package.json&quot;)));

  if (dirs.length === 0) {
    console.log(&quot;No workspaces found&quot;);
    return;
  }

  for (const dir of dirs) {
    const pkg = await Bun.file(join(dir, &quot;package.json&quot;)).json();
    if (pkg.scripts?.test) {
      console.log(`\n=== Testing ${pkg.name} ===`);
      await $`bun test ${dir}`.nothrow();
    }
  }
}

await runTests();</code></pre></figure></p>

<h4 id="h-16-copy-gitignore-44" data-section="44"><span class="section-num">44</span>1.6 Copy <code>.gitignore</code></h4>

<p><figure class="code-block" data-listing="23"><div class="code-bar"><span class="code-lang">gitignore</span><button class="code-copy">copy</button></div><pre class="language-gitignore"><code class="language-gitignore">node_modules/
dist/
.DS_Store
*.log
.env
.env.local
coverage/</code></pre></figure></p>

<h3 id="h-watch-out-for-45" data-section="45"><span class="section-num">45</span>Watch out for</h3>

<ul>
<li>If you change the workspace layout later, update <code>scripts/test-all.ts</code> accordingly.</li>
<li>The <code>overrides</code> in package.json are critical for solid-js compatibility.</li>
</ul>

<hr>

<h2 id="h-milestone-2-migrate-packagesai-46" data-section="46"><span class="section-num">46</span>Milestone 2: Migrate <code>packages/ai</code></h2>

<h3 id="h-goal-47" data-section="47"><span class="section-num">47</span>Goal</h3>

<p>Bring over the LLM API layer with minimal changes. This package defines types for tools, messages, and models.</p>

<h3 id="h-what-this-package-does-48" data-section="48"><span class="section-num">48</span>What this package does</h3>

<ul>
<li>Defines the <code>AgentTool</code> interface that all tools implement</li>
<li>Provides the model catalog (generated from provider APIs)</li>
<li>Contains provider-specific API wrappers</li>
<li>Exports types used throughout the codebase</li>
</ul>

<h3 id="h-verification-49" data-section="49"><span class="section-num">49</span>Verification</h3>

<li class="task"><span class="checkbox">[ ]</span> <code>bun run typecheck</code> for <code>packages/ai</code> passes.</li>
<li class="task"><span class="checkbox">[ ]</span> <code>bun run test</code> for <code>packages/ai</code> passes (currently a no-op).</li>

<h3 id="h-file-checklist-50" data-section="50"><span class="section-num">50</span>File checklist</h3>

<p><figure class="code-block" data-listing="24"><div class="code-bar"><span class="code-lang">text</span><button class="code-copy">copy</button></div><pre><code>packages/ai/
 package.json
 tsconfig.json
 tsconfig.build.json
 src/
    index.ts              # Main exports
    agent/
       types.ts          # AgentTool, AgentToolResult, etc.
    models.generated.ts   # Generated model catalog
    ...
 scripts/
     generate-models.ts    # Model generation script</code></pre></figure></p>

<h3 id="h-steps-51" data-section="51"><span class="section-num">51</span>Steps</h3>

<h4 id="h-21-copy-the-entire-package-52" data-section="52"><span class="section-num">52</span>2.1 Copy the entire package</h4>

<p><figure class="code-block" data-listing="25"><div class="code-bar"><span class="code-lang">bash</span><button class="code-copy">copy</button></div><pre class="language-bash"><code class="language-bash"># From old repo root
cp -r packages/ai ~/merlin/packages/</code></pre></figure></p>

<h4 id="h-22-update-packagejson-53" data-section="53"><span class="section-num">53</span>2.2 Update package.json</h4>

<p>Edit <code>packages/ai/package.json</code>:</p>

<p><figure class="code-block" data-listing="26"><div class="code-bar"><span class="code-lang">json</span><button class="code-copy">copy</button></div><pre class="language-json"><code class="language-json">{
  &quot;name&quot;: &quot;@merlin-agents/ai&quot;,
  &quot;version&quot;: &quot;0.1.0&quot;,
  &quot;type&quot;: &quot;module&quot;,
  &quot;exports&quot;: {
    &quot;.&quot;: &quot;./src/index.ts&quot;
  },
  &quot;scripts&quot;: {
    &quot;typecheck&quot;: &quot;tsc --noEmit&quot;,
    &quot;generate-models&quot;: &quot;bun scripts/generate-models.ts&quot;
  },
  &quot;dependencies&quot;: {
    &quot;@sinclair/typebox&quot;: &quot;^0.34.33&quot;
  },
  &quot;devDependencies&quot;: {
    &quot;typescript&quot;: &quot;^5.8.3&quot;
  },
  &quot;repository&quot;: {
    &quot;type&quot;: &quot;git&quot;,
    &quot;url&quot;: &quot;https://github.com/your-org/merlin&quot;
  }
}</code></pre></figure></p>

<strong>Key changes:</strong>
<ul>
<li><code>name</code> is now <code>@merlin-agents/ai</code></li>
<li>Updated <code>repository.url</code> to new repo</li>
</ul>

<h4 id="h-23-understand-the-key-types-54" data-section="54"><span class="section-num">54</span>2.3 Understand the key types</h4>

<p>The most important type is <code>AgentTool</code>:</p>

<p><figure class="code-block" data-listing="27"><div class="code-bar"><span class="code-lang">typescript</span><button class="code-copy">copy</button></div><pre class="language-typescript"><code class="language-typescript">// packages/ai/src/agent/types.ts
import type { Static, TSchema } from &quot;@sinclair/typebox&quot;;

export interface TextContent {
  type: &quot;text&quot;;
  text: string;
}

export interface ImageContent {
  type: &quot;image&quot;;
  source: { type: &quot;base64&quot;; media_type: string; data: string };
}

export interface AgentToolResult&lt;TDetails = unknown&gt; {
  content: (TextContent | ImageContent)[];
  details?: TDetails;
}

export interface AgentTool&lt;
  TParams extends TSchema = TSchema,
  TDetails = unknown
&gt; {
  name: string;
  label: string;
  description: string;
  parameters: TParams;
  execute: (
    toolCallId: string,
    params: Static&lt;TParams&gt;,
    signal?: AbortSignal,
    onUpdate?: (partial: AgentToolResult&lt;TDetails&gt;) =&gt; void
  ) =&gt; Promise&lt;AgentToolResult&lt;TDetails&gt;&gt;;
}</code></pre></figure></p>

<p>This interface is used by:<br><ul><br><li>Built-in tools (read, write, edit, bash)</li><br><li>Custom user tools</li><br><li>The agent loop to call tools</li><br></ul></p>

<h4 id="h-24-verify-model-generation-workflow-55" data-section="55"><span class="section-num">55</span>2.4 Verify model generation workflow</h4>

<p>The model catalog is generated from provider APIs. Don't run this unless you need updated models:</p>

<p><figure class="code-block" data-listing="28"><div class="code-bar"><span class="code-lang">bash</span><button class="code-copy">copy</button></div><pre class="language-bash"><code class="language-bash"># Only run when you need to update models
cd packages/ai
bun run generate-models</code></pre></figure></p>

<p>This hits OpenAI, Anthropic, and Google APIs to fetch available models.</p>

<p>Ensure <code>src/models.generated.ts</code> exists - it's required for typechecking.</p>

<h3 id="h-watch-out-for-56" data-section="56"><span class="section-num">56</span>Watch out for</h3>

<ul>
<li>Running <code>generate-models</code> requires network access and API keys</li>
<li>The generated file must be committed - it's not generated at build time</li>
<li>Keep all exports in <code>src/index.ts</code> intact - other packages depend on them</li>
</ul>

<hr>

<h2 id="h-milestone-3-migrate-packagesagent-57" data-section="57"><span class="section-num">57</span>Milestone 3: Migrate <code>packages/agent</code></h2>

<h3 id="h-goal-58" data-section="58"><span class="section-num">58</span>Goal</h3>

<p>Move the agent core and make the Codex instructions cache path configurable for embedding.</p>

<h3 id="h-what-this-package-does-59" data-section="59"><span class="section-num">59</span>What this package does</h3>

<ul>
<li><code>Agent</code> class: manages conversation state, runs the agent loop</li>
<li>Transports: handle communication with different LLM providers</li>
<li>Codex OAuth: manages authentication with OpenAI Codex</li>
<li>Types: message types, conversation events</li>
</ul>

<h3 id="h-verification-60" data-section="60"><span class="section-num">60</span>Verification</h3>

<li class="task"><span class="checkbox">[ ]</span> <code>bun run typecheck</code> for <code>packages/agent</code> passes.</li>
<li class="task"><span class="checkbox">[ ]</span> Codex transport still resolves instructions without errors when tokens exist.</li>

<h3 id="h-file-checklist-61" data-section="61"><span class="section-num">61</span>File checklist</h3>

<p><figure class="code-block" data-listing="29"><div class="code-bar"><span class="code-lang">text</span><button class="code-copy">copy</button></div><pre><code>packages/agent/
 package.json
 tsconfig.json
 src/
    index.ts
    agent.ts                    # Main Agent class
    types.ts                    # Message types, events
    codex-auth-cli.ts           # Token storage (NEEDS UPDATE)
    transports/
        index.ts
        RouterTransport.ts      # Routes to provider/codex
        ProviderTransport.ts    # Direct API calls
        CodexTransport.ts       # Codex OAuth (NEEDS UPDATE)
        codex/
            instructions.ts     # Cache logic (NEEDS UPDATE)
            types.ts
            constants.ts</code></pre></figure></p>

<h3 id="h-steps-62" data-section="62"><span class="section-num">62</span>Steps</h3>

<h4 id="h-31-copy-the-package-and-update-metadata-63" data-section="63"><span class="section-num">63</span>3.1 Copy the package and update metadata</h4>

<p><figure class="code-block" data-listing="30"><div class="code-bar"><span class="code-lang">bash</span><button class="code-copy">copy</button></div><pre class="language-bash"><code class="language-bash">cp -r packages/agent ~/merlin/packages/</code></pre></figure></p>

<p>Edit <code>packages/agent/package.json</code>:</p>

<p><figure class="code-block" data-listing="31"><div class="code-bar"><span class="code-lang">json</span><button class="code-copy">copy</button></div><pre class="language-json"><code class="language-json">{
  &quot;name&quot;: &quot;@merlin-agents/agent-core&quot;,
  &quot;version&quot;: &quot;0.1.0&quot;,
  &quot;type&quot;: &quot;module&quot;,
  &quot;exports&quot;: {
    &quot;.&quot;: &quot;./src/index.ts&quot;
  },
  &quot;dependencies&quot;: {
    &quot;@merlin-agents/ai&quot;: &quot;file:../ai&quot;
  },
  &quot;scripts&quot;: {
    &quot;typecheck&quot;: &quot;tsc --noEmit&quot;
  }
}</code></pre></figure></p>

<strong>Key changes:</strong>
<ul>
<li><code>name</code> is now <code>@merlin-agents/agent-core</code></li>
<li>Dependencies point to <code>@merlin-agents/ai</code></li>
</ul>

<h4 id="h-32-make-codex-instruction-caching-configurable-64" data-section="64"><span class="section-num">64</span>3.2 Make Codex instruction caching configurable</h4>

<strong>Before</strong> (<code>packages/agent/src/transports/codex/instructions.ts</code>):

<p><figure class="code-block" data-listing="32"><div class="code-bar"><span class="code-lang">typescript</span><button class="code-copy">copy</button></div><pre class="language-typescript"><code class="language-typescript">// Hardcoded path!
const CACHE_DIR = join(process.env.HOME || &quot;&quot;, &quot;.marvin&quot;, &quot;cache&quot;);</code></pre></figure></p>

<strong>After:</strong>

<p><figure class="code-block" data-listing="33"><div class="code-bar"><span class="code-lang">typescript</span><button class="code-copy">copy</button></div><pre class="language-typescript"><code class="language-typescript">// packages/agent/src/transports/codex/instructions.ts
import { join } from &quot;path&quot;;
import { existsSync, mkdirSync, readFileSync, writeFileSync } from &quot;fs&quot;;

// Default cache directory (can be overridden)
const DEFAULT_CACHE_DIR = join(process.env.HOME || &quot;&quot;, &quot;.merlin&quot;, &quot;cache&quot;);
const CACHE_TTL_MS = 15 * 60 * 1000; // 15 minutes

type ModelFamily = &quot;gpt-5.2-codex&quot; | &quot;gpt-5.2&quot;;

const PROMPT_FILES: Record&lt;ModelFamily, string&gt; = {
  &quot;gpt-5.2-codex&quot;: &quot;gpt-5.2-codex_prompt.md&quot;,
  &quot;gpt-5.2&quot;: &quot;gpt_5_2_prompt.md&quot;,
};

function getModelFamily(model: string): ModelFamily {
  const normalized = model.toLowerCase();
  if (normalized.includes(&quot;gpt-5.2-codex&quot;) || normalized.includes(&quot;gpt 5.2 codex&quot;)) {
    return &quot;gpt-5.2-codex&quot;;
  }
  return &quot;gpt-5.2&quot;;
}

function getCacheFiles(family: ModelFamily, cacheDir: string) {
  return {
    cache: join(cacheDir, `codex-instructions-${family}.md`),
    meta: join(cacheDir, `codex-instructions-${family}-meta.json`),
  };
}

// NEW: cacheDir parameter
export async function getCodexInstructions(
  model: string, 
  cacheDir?: string
): Promise&lt;string&gt; {
  const resolvedCacheDir = cacheDir ?? DEFAULT_CACHE_DIR;
  const family = getModelFamily(model);
  const { cache: cacheFile, meta: metaFile } = getCacheFiles(family, resolvedCacheDir);

  try {
    // Check if cached and TTL valid
    if (existsSync(metaFile) &amp;&amp; existsSync(cacheFile)) {
      const meta = JSON.parse(readFileSync(metaFile, &quot;utf-8&quot;));
      if (Date.now() - meta.lastChecked &lt; CACHE_TTL_MS) {
        return readFileSync(cacheFile, &quot;utf-8&quot;);
      }
    }

    // Fetch latest release tag from GitHub
    const tag = await getLatestReleaseTag();
    const promptFile = PROMPT_FILES[family];
    const url = `https://raw.githubusercontent.com/openai/codex/${tag}/codex-rs/core/${promptFile}`;

    // Check if tag matches cached version
    if (existsSync(metaFile) &amp;&amp; existsSync(cacheFile)) {
      const meta = JSON.parse(readFileSync(metaFile, &quot;utf-8&quot;));
      if (meta.tag === tag) {
        meta.lastChecked = Date.now();
        writeFileSync(metaFile, JSON.stringify(meta));
        return readFileSync(cacheFile, &quot;utf-8&quot;);
      }
    }

    // Fetch and cache
    const res = await fetch(url);
    if (!res.ok) throw new Error(`Failed to fetch instructions: ${res.status}`);
    const instructions = await res.text();

    mkdirSync(resolvedCacheDir, { recursive: true });
    writeFileSync(cacheFile, instructions);
    writeFileSync(metaFile, JSON.stringify({
      etag: res.headers.get(&quot;etag&quot;),
      tag,
      lastChecked: Date.now(),
    }));

    return instructions;
  } catch (err) {
    // Fallback: return stale cache if available
    if (existsSync(cacheFile)) {
      return readFileSync(cacheFile, &quot;utf-8&quot;);
    }
    throw err;
  }
}

async function getLatestReleaseTag(): Promise&lt;string&gt; {
  const res = await fetch(&quot;https://api.github.com/repos/openai/codex/releases/latest&quot;);
  if (!res.ok) throw new Error(`Failed to fetch release tag: ${res.status}`);
  const data = await res.json();
  return data.tag_name;
}</code></pre></figure></p>

<h4 id="h-33-update-codextransport-to-pass-cachedir-65" data-section="65"><span class="section-num">65</span>3.3 Update CodexTransport to pass cacheDir</h4>

<strong>Before:</strong>

<p><figure class="code-block" data-listing="34"><div class="code-bar"><span class="code-lang">typescript</span><button class="code-copy">copy</button></div><pre class="language-typescript"><code class="language-typescript">// packages/agent/src/transports/CodexTransport.ts
export interface CodexTransportOptions {
  getTokens: () =&gt; Promise&lt;CodexTokens | null&gt;;
  setTokens: (tokens: CodexTokens) =&gt; Promise&lt;void&gt;;
  clearTokens: () =&gt; Promise&lt;void&gt;;
}</code></pre></figure></p>

<strong>After:</strong>

<p><figure class="code-block" data-listing="35"><div class="code-bar"><span class="code-lang">typescript</span><button class="code-copy">copy</button></div><pre class="language-typescript"><code class="language-typescript">// packages/agent/src/transports/CodexTransport.ts
import { getCodexInstructions } from &quot;./codex/instructions.js&quot;;

export interface CodexTransportOptions {
  getTokens: () =&gt; Promise&lt;CodexTokens | null&gt;;
  setTokens: (tokens: CodexTokens) =&gt; Promise&lt;void&gt;;
  clearTokens: () =&gt; Promise&lt;void&gt;;
  cacheDir?: string;  // NEW: optional cache directory
}

export class CodexTransport implements AgentTransport {
  private instructionsCache: Record&lt;string, string&gt; = {};
  private options: CodexTransportOptions;

  constructor(options: CodexTransportOptions) {
    this.options = options;
  }

  private async getInstructions(modelId: string): Promise&lt;string&gt; {
    // Cache per model family
    const cacheKey = modelId.toLowerCase().includes(&quot;codex&quot;) ? &quot;codex&quot; : &quot;general&quot;;
    if (!this.instructionsCache[cacheKey]) {
      // Pass cacheDir to the instructions fetcher
      this.instructionsCache[cacheKey] = await getCodexInstructions(
        modelId, 
        this.options.cacheDir
      );
    }
    return this.instructionsCache[cacheKey];
  }

  // ... rest of implementation unchanged
}</code></pre></figure></p>

<h4 id="h-34-update-codex-auth-cli-defaults-66" data-section="66"><span class="section-num">66</span>3.4 Update Codex auth CLI defaults</h4>

<strong>Before:</strong>

<p><figure class="code-block" data-listing="36"><div class="code-bar"><span class="code-lang">typescript</span><button class="code-copy">copy</button></div><pre class="language-typescript"><code class="language-typescript">// packages/agent/src/codex-auth-cli.ts
const DEFAULT_CONFIG_DIR = join(homedir(), &quot;.config&quot;, &quot;marvin&quot;);
const LEGACY_CONFIG_DIR = join(homedir(), &quot;.marvin&quot;);</code></pre></figure></p>

<strong>After:</strong>

<p><figure class="code-block" data-listing="37"><div class="code-bar"><span class="code-lang">typescript</span><button class="code-copy">copy</button></div><pre class="language-typescript"><code class="language-typescript">// packages/agent/src/codex-auth-cli.ts
import { homedir } from &quot;os&quot;;
import { join, basename, dirname } from &quot;path&quot;;
import { existsSync, readFileSync, writeFileSync, mkdirSync, chmodSync, renameSync, unlinkSync } from &quot;fs&quot;;

// NEW: Updated default to merlin
const DEFAULT_CONFIG_DIR = join(homedir(), &quot;.config&quot;, &quot;merlin&quot;);

// Legacy paths for migration
const LEGACY_CONFIG_DIRS = [
  join(homedir(), &quot;.config&quot;, &quot;marvin&quot;),  // Previous XDG location
  join(homedir(), &quot;.marvin&quot;),             // Original legacy location
];

export interface TokenStoreOptions {
  configDir?: string;
  tokensFile?: string;
}

function resolveTokensFile(options?: TokenStoreOptions): string {
  if (options?.tokensFile) return options.tokensFile;
  const configDir = options?.configDir ?? DEFAULT_CONFIG_DIR;
  return join(configDir, &quot;codex-tokens.json&quot;);
}

function findLegacyTokensFile(): string | null {
  for (const dir of LEGACY_CONFIG_DIRS) {
    const file = join(dir, &quot;codex-tokens.json&quot;);
    if (existsSync(file)) {
      return file;
    }
  }
  return null;
}

export function loadTokens(options?: TokenStoreOptions): CodexTokens | null {
  const tokensFile = resolveTokensFile(options);
  
  // Try primary location first
  try {
    const data = readFileSync(tokensFile, &quot;utf-8&quot;);
    const parsed = JSON.parse(data);
    if (isCodexTokens(parsed)) return parsed;
  } catch {
    // Fall through to legacy
  }

  // Only check legacy if using default config (not custom path)
  if (options?.configDir || options?.tokensFile) {
    return null;
  }

  // Try legacy locations
  const legacyFile = findLegacyTokensFile();
  if (!legacyFile) return null;

  try {
    const data = readFileSync(legacyFile, &quot;utf-8&quot;);
    const parsed = JSON.parse(data);
    if (!isCodexTokens(parsed)) return null;

    // Migrate to new location (best-effort)
    try {
      saveTokens(parsed, { configDir: DEFAULT_CONFIG_DIR });
      unlinkSync(legacyFile);
      console.error(`Migrated Codex tokens from ${legacyFile} to ${tokensFile}`);
    } catch {
      // Migration failed, but we have the tokens
    }

    return parsed;
  } catch {
    return null;
  }
}

// Security: 0o700 for directories, 0o600 for files
function ensurePrivateDirSync(dir: string): void {
  mkdirSync(dir, { recursive: true, mode: 0o700 });
  try {
    chmodSync(dir, 0o700);
  } catch {
    // best-effort
  }
}

function writePrivateFileAtomicSync(filePath: string, contents: string): void {
  const dir = dirname(filePath);
  ensurePrivateDirSync(dir);
  
  // Write to temp file, then atomic rename
  const tmpPath = join(dir, `.${basename(filePath)}.tmp.${process.pid}.${Date.now()}`);
  try {
    writeFileSync(tmpPath, contents, { mode: 0o600 });
    renameSync(tmpPath, filePath);
    chmodSync(filePath, 0o600);
  } finally {
    try { unlinkSync(tmpPath); } catch { /* cleanup */ }
  }
}

export function saveTokens(tokens: CodexTokens, options?: TokenStoreOptions): void {
  const tokensFile = resolveTokensFile(options);
  writePrivateFileAtomicSync(tokensFile, `${JSON.stringify(tokens, null, 2)}\n`);
}

export function clearTokens(options?: TokenStoreOptions): void {
  const tokensFile = resolveTokensFile(options);
  try {
    unlinkSync(tokensFile);
  } catch {
    // File doesn't exist, that's fine
  }
}

function isCodexTokens(obj: unknown): obj is CodexTokens {
  return (
    typeof obj === &quot;object&quot; &amp;&amp;
    obj !== null &amp;&amp;
    &quot;access&quot; in obj &amp;&amp;
    &quot;refresh&quot; in obj &amp;&amp;
    &quot;expires&quot; in obj &amp;&amp;
    typeof (obj as any).access === &quot;string&quot; &amp;&amp;
    typeof (obj as any).refresh === &quot;string&quot; &amp;&amp;
    typeof (obj as any).expires === &quot;number&quot;
  );
}</code></pre></figure></p>

<h3 id="h-watch-out-for-67" data-section="67"><span class="section-num">67</span>Watch out for</h3>

<ul>
<li>Adding <code>cacheDir</code> is a public API change - keep it optional with a sensible default</li>
<li>The legacy migration should be transparent to users - they shouldn't need to do anything</li>
<li>Token files contain secrets - always use restrictive file permissions</li>
</ul>

<hr>

<h2 id="h-milestone-4-migrate-packagesbase-tools-and-make-tools-cwd-aware-68" data-section="68"><span class="section-num">68</span>Milestone 4: Migrate <code>packages/base-tools</code> and make tools cwd-aware</h2>

<h3 id="h-goal-69" data-section="69"><span class="section-num">69</span>Goal</h3>

<p>Add factory functions so tools can be bound to a specific cwd while keeping existing default exports.</p>

<h3 id="h-what-this-package-does-70" data-section="70"><span class="section-num">70</span>What this package does</h3>

<ul>
<li>Provides the four core tools: <code>read</code>, <code>write</code>, <code>edit</code>, <code>bash</code></li>
<li>Handles path resolution and expansion</li>
<li>Manages file truncation for large outputs</li>
</ul>

<h3 id="h-verification-71" data-section="71"><span class="section-num">71</span>Verification</h3>

<li class="task"><span class="checkbox">[ ]</span> <code>bun run test</code> for <code>packages/base-tools</code> runs real tests.</li>
<li class="task"><span class="checkbox">[ ]</span> A new unit test confirms <code>resolvePathFromCwd</code> works correctly.</li>

<h3 id="h-file-checklist-72" data-section="72"><span class="section-num">72</span>File checklist</h3>

<p><figure class="code-block" data-listing="38"><div class="code-bar"><span class="code-lang">text</span><button class="code-copy">copy</button></div><pre><code>packages/base-tools/
 package.json
 tsconfig.json
 src/
    index.ts              # Main exports (NEEDS UPDATE)
    tools/
        path-utils.ts     # Path resolution (NEEDS UPDATE)
        read.ts           # Read tool (NEEDS UPDATE)
        write.ts          # Write tool (NEEDS UPDATE)
        edit.ts           # Edit tool (NEEDS UPDATE)
        bash.ts           # Bash tool (NEEDS UPDATE)
        truncate.ts       # Truncation logic (unchanged)
 tests/
     path-utils.test.ts    # NEW: Unit tests</code></pre></figure></p>

<h3 id="h-steps-73" data-section="73"><span class="section-num">73</span>Steps</h3>

<h4 id="h-41-update-package-metadata-74" data-section="74"><span class="section-num">74</span>4.1 Update package metadata</h4>

<p>Edit <code>packages/base-tools/package.json</code>:</p>

<p><figure class="code-block" data-listing="39"><div class="code-bar"><span class="code-lang">json</span><button class="code-copy">copy</button></div><pre class="language-json"><code class="language-json">{
  &quot;name&quot;: &quot;@merlin-agents/base-tools&quot;,
  &quot;version&quot;: &quot;0.1.0&quot;,
  &quot;type&quot;: &quot;module&quot;,
  &quot;exports&quot;: {
    &quot;.&quot;: &quot;./src/index.ts&quot;
  },
  &quot;dependencies&quot;: {
    &quot;@merlin-agents/ai&quot;: &quot;file:../ai&quot;
  },
  &quot;scripts&quot;: {
    &quot;typecheck&quot;: &quot;tsc --noEmit&quot;,
    &quot;test&quot;: &quot;bun test tests/&quot;
  }
}</code></pre></figure></p>

<h4 id="h-42-extend-path-utilities-with-cwd-helpers-75" data-section="75"><span class="section-num">75</span>4.2 Extend path utilities with cwd helpers</h4>

<p>This is the core change. We need to support binding tools to a specific working directory.</p>

<strong>Create new path-utils.ts:</strong>

<p><figure class="code-block" data-listing="40"><div class="code-bar"><span class="code-lang">typescript</span><button class="code-copy">copy</button></div><pre class="language-typescript"><code class="language-typescript">// packages/base-tools/src/tools/path-utils.ts
import { accessSync, constants } from &quot;node:fs&quot;;
import * as os from &quot;node:os&quot;;
import { resolve as pathResolve } from &quot;node:path&quot;;

const UNICODE_SPACES = /[\u00A0\u2000-\u200A\u202F\u205F\u3000]/g;
const NARROW_NO_BREAK_SPACE = &quot;\u202F&quot;;

function normalizeUnicodeSpaces(str: string): string {
  return str.replace(UNICODE_SPACES, &quot; &quot;);
}

function tryMacOSScreenshotPath(filePath: string): string {
  return filePath.replace(/ (AM|PM)\./g, `${NARROW_NO_BREAK_SPACE}$1.`);
}

function fileExists(filePath: string): boolean {
  try {
    accessSync(filePath, constants.F_OK);
    return true;
  } catch {
    return false;
  }
}

// Expands ~ to home directory
export function expandPath(filePath: string): string {
  const normalized = normalizeUnicodeSpaces(filePath);
  if (normalized === &quot;~&quot;) {
    return os.homedir();
  }
  if (normalized.startsWith(&quot;~/&quot;)) {
    return os.homedir() + normalized.slice(1);
  }
  return normalized;
}

// For read operations: tries literal path first, then macOS variant
export function resolveReadPath(filePath: string): string {
  const expanded = expandPath(filePath);

  if (fileExists(expanded)) {
    return expanded;
  }

  const macOSVariant = tryMacOSScreenshotPath(expanded);
  if (macOSVariant !== expanded &amp;&amp; fileExists(macOSVariant)) {
    return macOSVariant;
  }

  return expanded;
}

// ============================================================
// NEW: CWD-aware path resolution
// ============================================================

/**
 * CwdLike can be:
 * - A string (the working directory path)
 * - A function that returns the working directory
 * - undefined (use process.cwd())
 */
export type CwdLike = string | (() =&gt; string) | undefined;

/**
 * A CwdResolver is a function that returns the current working directory.
 * We use functions instead of capturing strings to support dynamic cwd scenarios.
 */
export type CwdResolver = () =&gt; string;

/**
 * Converts a CwdLike to a CwdResolver function.
 * 
 * Why a function? Because we don't want to capture process.cwd() at module
 * import time. That would break tools if the process cwd changes later.
 */
export function toCwdResolver(cwd: CwdLike): CwdResolver {
  if (cwd === undefined) {
    // Default: use process.cwd() at call time
    return () =&gt; process.cwd();
  }
  if (typeof cwd === &quot;function&quot;) {
    return cwd;
  }
  // String: return a constant
  return () =&gt; cwd;
}

/**
 * Resolves a file path relative to a cwd.
 * 
 * - If path starts with ~, expands to home directory
 * - If path is absolute, returns as-is
 * - If path is relative, resolves against cwd
 */
export function resolvePathFromCwd(filePath: string, cwd: CwdResolver): string {
  const expanded = expandPath(filePath);
  
  // If already absolute, just return it
  if (expanded.startsWith(&quot;/&quot;) || /^[A-Za-z]:[\\/]/.test(expanded)) {
    return expanded;
  }
  
  // Resolve relative to cwd
  return pathResolve(cwd(), expanded);
}

/**
 * Like resolvePathFromCwd, but with macOS screenshot path handling.
 * Used by the read tool.
 */
export function resolveReadPathFromCwd(filePath: string, cwd: CwdResolver): string {
  const expanded = expandPath(filePath);
  
  // For absolute paths, check macOS variant first
  if (expanded.startsWith(&quot;/&quot;) || /^[A-Za-z]:[\\/]/.test(expanded)) {
    if (fileExists(expanded)) {
      return expanded;
    }
    const macOSVariant = tryMacOSScreenshotPath(expanded);
    if (macOSVariant !== expanded &amp;&amp; fileExists(macOSVariant)) {
      return macOSVariant;
    }
    return expanded;
  }
  
  // For relative paths, resolve against cwd first, then check variants
  const resolved = pathResolve(cwd(), expanded);
  if (fileExists(resolved)) {
    return resolved;
  }
  
  const macOSVariant = tryMacOSScreenshotPath(resolved);
  if (macOSVariant !== resolved &amp;&amp; fileExists(macOSVariant)) {
    return macOSVariant;
  }
  
  return resolved;
}</code></pre></figure></p>

<h4 id="h-43-add-tool-factories-76" data-section="76"><span class="section-num">76</span>4.3 Add tool factories</h4>

<p>Now we create factory functions for each tool. Each factory returns a tool bound to a specific cwd.</p>

<strong>read.ts - Add createReadTool:</strong>

<p><figure class="code-block" data-listing="41"><div class="code-bar"><span class="code-lang">typescript</span><button class="code-copy">copy</button></div><pre class="language-typescript"><code class="language-typescript">// packages/base-tools/src/tools/read.ts
import type { AgentTool } from &quot;@merlin-agents/ai&quot;;
import { Type } from &quot;@sinclair/typebox&quot;;
import { readFile, stat } from &quot;node:fs/promises&quot;;
import { 
  resolveReadPath, 
  resolveReadPathFromCwd, 
  toCwdResolver,
  type CwdLike 
} from &quot;./path-utils.js&quot;;
import { detectSupportedImageMimeTypeFromFile } from &quot;../utils/mime.js&quot;;
import { truncateOutput, LINE_LIMIT, SIZE_LIMIT } from &quot;./truncate.js&quot;;

const schema = Type.Object({
  path: Type.String({ description: &quot;Path to the file to read (relative or absolute)&quot; }),
  offset: Type.Optional(Type.Number({ description: &quot;Line number to start from (1-indexed)&quot; })),
  limit: Type.Optional(Type.Number({ description: &quot;Max lines to read&quot; })),
});

export interface ReadDetails {
  path: string;
  mimeType: string | null;
  lineCount: number | null;
  truncated: boolean;
  offset: number | null;
  limit: number | null;
}

/**
 * Creates a read tool bound to a specific working directory.
 * 
 * @param cwd - The working directory. Can be:
 *   - A string path
 *   - A function that returns a path
 *   - undefined (uses process.cwd())
 */
export function createReadTool(cwd: CwdLike): AgentTool&lt;typeof schema, ReadDetails&gt; {
  const resolveCwd = toCwdResolver(cwd);

  return {
    name: &quot;read&quot;,
    label: &quot;read&quot;,
    description: `Read the contents of a file. Supports text files and images (jpg, png, gif, webp). Images are sent as attachments. Returns full file content by default  only files exceeding ${LINE_LIMIT} lines or ${Math.round(SIZE_LIMIT / 1024)}KB are truncated (with instructions to continue).`,
    parameters: schema,
    execute: async (_toolCallId, params, signal) =&gt; {
      if (signal?.aborted) throw new Error(&quot;aborted&quot;);

      const { path, offset, limit } = params;
      
      // Use cwd-aware resolution
      const absolutePath = resolveReadPathFromCwd(path, resolveCwd);

      // Check if it's an image
      const mimeType = await detectSupportedImageMimeTypeFromFile(absolutePath);
      if (mimeType) {
        const buffer = await readFile(absolutePath);
        const base64 = buffer.toString(&quot;base64&quot;);
        return {
          content: [{ type: &quot;image&quot;, source: { type: &quot;base64&quot;, media_type: mimeType, data: base64 } }],
          details: { path: absolutePath, mimeType, lineCount: null, truncated: false, offset: null, limit: null },
        };
      }

      // Read text file
      const content = await readFile(absolutePath, &quot;utf-8&quot;);
      const lines = content.split(&quot;\n&quot;);
      const lineCount = lines.length;

      // Handle offset/limit
      const startLine = offset ? Math.max(1, offset) - 1 : 0;
      const endLine = limit ? startLine + limit : lines.length;
      const selectedLines = lines.slice(startLine, endLine);
      const selectedContent = selectedLines.join(&quot;\n&quot;);

      // Truncate if needed
      const { text, truncated, actualOffset, actualLimit } = truncateOutput(
        selectedContent,
        offset,
        limit
      );

      return {
        content: [{ type: &quot;text&quot;, text }],
        details: {
          path: absolutePath,
          mimeType: null,
          lineCount,
          truncated,
          offset: actualOffset,
          limit: actualLimit,
        },
      };
    },
  };
}

// Default export uses process.cwd()
export const readTool = createReadTool(undefined);</code></pre></figure></p>

<strong>bash.ts - Add createBashTool:</strong>

<p><figure class="code-block" data-listing="42"><div class="code-bar"><span class="code-lang">typescript</span><button class="code-copy">copy</button></div><pre class="language-typescript"><code class="language-typescript">// packages/base-tools/src/tools/bash.ts
import type { AgentTool } from &quot;@merlin-agents/ai&quot;;
import { Type } from &quot;@sinclair/typebox&quot;;
import { spawn } from &quot;child_process&quot;;
import { getShellConfig, killProcessTree } from &quot;../utils/shell.js&quot;;
import { truncateOutput } from &quot;./truncate.js&quot;;
import { toCwdResolver, type CwdLike } from &quot;./path-utils.js&quot;;

const schema = Type.Object({
  command: Type.String({ description: &quot;Bash command to execute&quot; }),
  timeout: Type.Optional(Type.Number({ description: &quot;Timeout in seconds (optional)&quot; })),
});

export interface BashDetails {
  code: number | null;
  signal: string | null;
  truncated: boolean;
}

/**
 * Creates a bash tool bound to a specific working directory.
 */
export function createBashTool(cwd: CwdLike): AgentTool&lt;typeof schema, BashDetails&gt; {
  const resolveCwd = toCwdResolver(cwd);

  return {
    name: &quot;bash&quot;,
    label: &quot;bash&quot;,
    description: &quot;Execute a bash command in the current working directory. Returns stdout and stderr. Output is truncated to last 1500 lines or 100KB (whichever is hit first). If truncated, full output is saved to a temp file. Optionally provide a timeout in seconds.&quot;,
    parameters: schema,
    execute: async (_toolCallId, params, signal) =&gt; {
      if (signal?.aborted) throw new Error(&quot;aborted&quot;);

      const { command, timeout } = params;
      const { shell, args } = getShellConfig();
      
      return new Promise((resolve, reject) =&gt; {
        const child = spawn(shell, [...args, command], {
          detached: true,
          stdio: [&quot;ignore&quot;, &quot;pipe&quot;, &quot;pipe&quot;],
          cwd: resolveCwd(),  // &lt;-- NOW USES CWD!
        });

        let stdout = &quot;&quot;;
        let stderr = &quot;&quot;;
        let killed = false;
        let timeoutId: ReturnType&lt;typeof setTimeout&gt; | undefined;

        // Handle abort signal
        const onAbort = () =&gt; {
          killed = true;
          killProcessTree(child.pid!);
          reject(new Error(&quot;aborted&quot;));
        };

        signal?.addEventListener(&quot;abort&quot;, onAbort, { once: true });

        // Handle timeout
        if (timeout &amp;&amp; timeout &gt; 0) {
          timeoutId = setTimeout(() =&gt; {
            killed = true;
            killProcessTree(child.pid!);
          }, timeout * 1000);
        }

        child.stdout.on(&quot;data&quot;, (data) =&gt; { stdout += data.toString(); });
        child.stderr.on(&quot;data&quot;, (data) =&gt; { stderr += data.toString(); });

        child.on(&quot;error&quot;, (err) =&gt; {
          if (timeoutId) clearTimeout(timeoutId);
          signal?.removeEventListener(&quot;abort&quot;, onAbort);
          reject(err);
        });

        child.on(&quot;close&quot;, (code, sig) =&gt; {
          if (timeoutId) clearTimeout(timeoutId);
          signal?.removeEventListener(&quot;abort&quot;, onAbort);

          const combined = stdout + stderr;
          const { text, truncated } = truncateOutput(combined);

          resolve({
            content: [{ type: &quot;text&quot;, text }],
            details: {
              code: killed &amp;&amp; timeout ? null : code,
              signal: killed ? (timeout ? &quot;TIMEOUT&quot; : &quot;ABORT&quot;) : sig,
              truncated,
            },
          });
        });
      });
    },
  };
}

// Default export uses process.cwd()
export const bashTool = createBashTool(undefined);</code></pre></figure></p>

<strong>write.ts - Add createWriteTool:</strong>

<p><figure class="code-block" data-listing="43"><div class="code-bar"><span class="code-lang">typescript</span><button class="code-copy">copy</button></div><pre class="language-typescript"><code class="language-typescript">// packages/base-tools/src/tools/write.ts
import type { AgentTool } from &quot;@merlin-agents/ai&quot;;
import { Type } from &quot;@sinclair/typebox&quot;;
import { mkdir, writeFile } from &quot;node:fs/promises&quot;;
import { dirname } from &quot;node:path&quot;;
import { expandPath, resolvePathFromCwd, toCwdResolver, type CwdLike } from &quot;./path-utils.js&quot;;

const schema = Type.Object({
  path: Type.String({ description: &quot;Path to the file to write (relative or absolute)&quot; }),
  content: Type.String({ description: &quot;Content to write to the file&quot; }),
});

export interface WriteDetails {
  path: string;
  bytesWritten: number;
}

/**
 * Creates a write tool bound to a specific working directory.
 */
export function createWriteTool(cwd: CwdLike): AgentTool&lt;typeof schema, WriteDetails&gt; {
  const resolveCwd = toCwdResolver(cwd);

  return {
    name: &quot;write&quot;,
    label: &quot;write&quot;,
    description: &quot;Write content to a file. Creates the file if it doesn't exist, overwrites if it does. Automatically creates parent directories.&quot;,
    parameters: schema,
    execute: async (_toolCallId, params, signal) =&gt; {
      if (signal?.aborted) throw new Error(&quot;aborted&quot;);

      const { path, content } = params;
      
      // Use cwd-aware resolution
      const absolutePath = resolvePathFromCwd(path, resolveCwd);
      const dir = dirname(absolutePath);

      // Ensure directory exists
      await mkdir(dir, { recursive: true });
      
      // Write file
      await writeFile(absolutePath, content, &quot;utf-8&quot;);

      return {
        content: [{ type: &quot;text&quot;, text: `Wrote ${content.length} bytes to ${absolutePath}` }],
        details: { path: absolutePath, bytesWritten: content.length },
      };
    },
  };
}

// Default export uses process.cwd()
export const writeTool = createWriteTool(undefined);</code></pre></figure></p>

<strong>edit.ts - Add createEditTool:</strong>

<p><figure class="code-block" data-listing="44"><div class="code-bar"><span class="code-lang">typescript</span><button class="code-copy">copy</button></div><pre class="language-typescript"><code class="language-typescript">// packages/base-tools/src/tools/edit.ts
import type { AgentTool } from &quot;@merlin-agents/ai&quot;;
import { Type } from &quot;@sinclair/typebox&quot;;
import { readFile, writeFile } from &quot;node:fs/promises&quot;;
import { resolvePathFromCwd, toCwdResolver, type CwdLike } from &quot;./path-utils.js&quot;;

const schema = Type.Object({
  path: Type.String({ description: &quot;Path to the file to edit (relative or absolute)&quot; }),
  oldText: Type.String({ description: &quot;Exact text to find and replace (must match exactly)&quot; }),
  newText: Type.String({ description: &quot;New text to replace the old text with&quot; }),
});

export interface EditDetails {
  path: string;
  matchCount: number;
}

/**
 * Creates an edit tool bound to a specific working directory.
 */
export function createEditTool(cwd: CwdLike): AgentTool&lt;typeof schema, EditDetails&gt; {
  const resolveCwd = toCwdResolver(cwd);

  return {
    name: &quot;edit&quot;,
    label: &quot;edit&quot;,
    description: &quot;Edit a file by replacing exact text. The oldText must match exactly (including whitespace). Use this for precise, surgical edits.&quot;,
    parameters: schema,
    execute: async (_toolCallId, params, signal) =&gt; {
      if (signal?.aborted) throw new Error(&quot;aborted&quot;);

      const { path, oldText, newText } = params;
      
      // Use cwd-aware resolution
      const absolutePath = resolvePathFromCwd(path, resolveCwd);

      // Read current content
      const content = await readFile(absolutePath, &quot;utf-8&quot;);

      // Check if oldText exists
      if (!content.includes(oldText)) {
        throw new Error(`Could not find text to replace in ${absolutePath}. The oldText must match exactly.`);
      }

      // Count occurrences
      let matchCount = 0;
      let searchPos = 0;
      while ((searchPos = content.indexOf(oldText, searchPos)) !== -1) {
        matchCount++;
        searchPos += oldText.length;
      }

      // Replace all occurrences
      const newContent = content.replaceAll(oldText, newText);
      await writeFile(absolutePath, newContent, &quot;utf-8&quot;);

      const message = matchCount === 1
        ? `Replaced 1 occurrence in ${absolutePath}`
        : `Replaced ${matchCount} occurrences in ${absolutePath}`;

      return {
        content: [{ type: &quot;text&quot;, text: message }],
        details: { path: absolutePath, matchCount },
      };
    },
  };
}

// Default export uses process.cwd()
export const editTool = createEditTool(undefined);</code></pre></figure></p>

<h4 id="h-44-add-createcodingtools-helper-77" data-section="77"><span class="section-num">77</span>4.4 Use <code>createToolRegistry</code> only (no legacy helper)</h4><p>Do not add <code>createCodingTools</code> or export default tool singletons. Keep the index focused on factories and the cwd-scoped registry.</p><p><figure class="code-block" data-listing="44"><div class="code-bar"><span class="code-lang">typescript</span><button class="code-copy">copy</button></div><pre class="language-typescript"><code class="language-typescript">// packages/base-tools/src/index.ts
export { createToolRegistry, type ToolDef, type ToolRegistry } from "./tool-registry.js";
export { createReadTool } from "./tools/read.js";
export { createWriteTool } from "./tools/write.js";
export { createEditTool } from "./tools/edit.js";
export { createBashTool } from "./tools/bash.js";
</code></pre></figure></p><h4 id="h-45-add-unit-tests-78" data-section="78"><span class="section-num">78</span>4.5 Add unit tests</h4>

<p>Create <code>packages/base-tools/tests/path-utils.test.ts</code>:</p>

<p><figure class="code-block" data-listing="46"><div class="code-bar"><span class="code-lang">typescript</span><button class="code-copy">copy</button></div><pre class="language-typescript"><code class="language-typescript">import { describe, test, expect, beforeEach, afterEach } from &quot;bun:test&quot;;
import { mkdirSync, writeFileSync, rmSync } from &quot;node:fs&quot;;
import { join } from &quot;node:path&quot;;
import { tmpdir } from &quot;node:os&quot;;
import { 
  expandPath, 
  resolvePathFromCwd, 
  resolveReadPathFromCwd,
  toCwdResolver 
} from &quot;../src/tools/path-utils.js&quot;;

describe(&quot;expandPath&quot;, () =&gt; {
  test(&quot;expands ~ to home directory&quot;, () =&gt; {
    const result = expandPath(&quot;~&quot;);
    expect(result).toBe(process.env.HOME);
  });

  test(&quot;expands ~/path to home directory + path&quot;, () =&gt; {
    const result = expandPath(&quot;~/foo/bar&quot;);
    expect(result).toBe(`${process.env.HOME}/foo/bar`);
  });

  test(&quot;leaves absolute paths unchanged&quot;, () =&gt; {
    const result = expandPath(&quot;/absolute/path&quot;);
    expect(result).toBe(&quot;/absolute/path&quot;);
  });

  test(&quot;leaves relative paths unchanged&quot;, () =&gt; {
    const result = expandPath(&quot;relative/path&quot;);
    expect(result).toBe(&quot;relative/path&quot;);
  });
});

describe(&quot;toCwdResolver&quot;, () =&gt; {
  test(&quot;undefined returns process.cwd resolver&quot;, () =&gt; {
    const resolver = toCwdResolver(undefined);
    expect(resolver()).toBe(process.cwd());
  });

  test(&quot;string returns constant resolver&quot;, () =&gt; {
    const resolver = toCwdResolver(&quot;/custom/path&quot;);
    expect(resolver()).toBe(&quot;/custom/path&quot;);
  });

  test(&quot;function is returned as-is&quot;, () =&gt; {
    const fn = () =&gt; &quot;/dynamic/path&quot;;
    const resolver = toCwdResolver(fn);
    expect(resolver).toBe(fn);
    expect(resolver()).toBe(&quot;/dynamic/path&quot;);
  });
});

describe(&quot;resolvePathFromCwd&quot;, () =&gt; {
  test(&quot;absolute paths are returned unchanged&quot;, () =&gt; {
    const cwd = toCwdResolver(&quot;/some/dir&quot;);
    const result = resolvePathFromCwd(&quot;/absolute/path&quot;, cwd);
    expect(result).toBe(&quot;/absolute/path&quot;);
  });

  test(&quot;relative paths are resolved against cwd&quot;, () =&gt; {
    const cwd = toCwdResolver(&quot;/project/root&quot;);
    const result = resolvePathFromCwd(&quot;src/file.ts&quot;, cwd);
    expect(result).toBe(&quot;/project/root/src/file.ts&quot;);
  });

  test(&quot;tilde paths are expanded before resolution&quot;, () =&gt; {
    const cwd = toCwdResolver(&quot;/project/root&quot;);
    const result = resolvePathFromCwd(&quot;~/Documents/file.txt&quot;, cwd);
    expect(result).toBe(`${process.env.HOME}/Documents/file.txt`);
  });

  test(&quot;.. navigation works correctly&quot;, () =&gt; {
    const cwd = toCwdResolver(&quot;/project/root/src&quot;);
    const result = resolvePathFromCwd(&quot;../package.json&quot;, cwd);
    expect(result).toBe(&quot;/project/root/package.json&quot;);
  });
});

describe(&quot;resolveReadPathFromCwd&quot;, () =&gt; {
  let testDir: string;

  beforeEach(() =&gt; {
    testDir = join(tmpdir(), `path-utils-test-${Date.now()}`);
    mkdirSync(testDir, { recursive: true });
  });

  afterEach(() =&gt; {
    rmSync(testDir, { recursive: true, force: true });
  });

  test(&quot;resolves existing files&quot;, () =&gt; {
    const filePath = join(testDir, &quot;test.txt&quot;);
    writeFileSync(filePath, &quot;content&quot;);
    
    const cwd = toCwdResolver(testDir);
    const result = resolveReadPathFromCwd(&quot;test.txt&quot;, cwd);
    expect(result).toBe(filePath);
  });

  test(&quot;returns resolved path for non-existent files&quot;, () =&gt; {
    const cwd = toCwdResolver(testDir);
    const result = resolveReadPathFromCwd(&quot;nonexistent.txt&quot;, cwd);
    expect(result).toBe(join(testDir, &quot;nonexistent.txt&quot;));
  });
});</code></pre></figure></p>

<h3 id="h-watch-out-for-79" data-section="79"><span class="section-num">79</span>Watch out for</h3>

<ul>
<li><strong>Never capture <code>process.cwd()</code> at module import time</strong> - always use <code>toCwdResolver</code> to defer resolution</li>
<li>The factories are the primary API for SDK users - the default exports are for backwards compatibility</li>
<li>Do not export legacy tool arrays; use the tool registry + factories instead</li>
</ul>

<hr>

<h2 id="h-milestone-5-migrate-packageslsp-80" data-section="80"><span class="section-num">80</span>Milestone 5: Migrate <code>packages/lsp</code></h2>

<h3 id="h-goal-81" data-section="81"><span class="section-num">81</span>Goal</h3>

<p>Keep LSP wrappers compatible with cwd-bound tools and remove implicit cwd assumptions.</p>

<h3 id="h-what-this-package-does-82" data-section="82"><span class="section-num">82</span>What this package does</h3>

<ul>
<li>Wraps <code>write</code> and <code>edit</code> tools to run LSP diagnostics after file changes</li>
<li>Shows TypeScript errors inline in the agent response</li>
<li>Only wraps tools that modify files (not <code>read</code> or <code>bash</code>)</li>
</ul>

<h3 id="h-verification-83" data-section="83"><span class="section-num">83</span>Verification</h3>

<li class="task"><span class="checkbox">[ ]</span> <code>bun run typecheck</code> for <code>packages/lsp</code> passes.</li>

<h3 id="h-file-checklist-84" data-section="84"><span class="section-num">84</span>File checklist</h3>

<p><figure class="code-block" data-listing="47"><div class="code-bar"><span class="code-lang">text</span><button class="code-copy">copy</button></div><pre><code>packages/lsp/
 package.json
 tsconfig.json
 src/
     index.ts
     tool-wrapper.ts    # Main wrapper logic
     lsp-manager.ts     # LSP client management</code></pre></figure></p>

<h3 id="h-steps-85" data-section="85"><span class="section-num">85</span>Steps</h3>

<h4 id="h-51-copy-and-update-metadata-86" data-section="86"><span class="section-num">86</span>5.1 Copy and update metadata</h4>

<p>Edit <code>packages/lsp/package.json</code>:</p>

<p><figure class="code-block" data-listing="48"><div class="code-bar"><span class="code-lang">json</span><button class="code-copy">copy</button></div><pre class="language-json"><code class="language-json">{
  &quot;name&quot;: &quot;@merlin-agents/lsp&quot;,
  &quot;version&quot;: &quot;0.1.0&quot;,
  &quot;type&quot;: &quot;module&quot;,
  &quot;exports&quot;: {
    &quot;.&quot;: &quot;./src/index.ts&quot;
  },
  &quot;dependencies&quot;: {
    &quot;@merlin-agents/ai&quot;: &quot;file:../ai&quot;
  },
  &quot;scripts&quot;: {
    &quot;typecheck&quot;: &quot;tsc --noEmit&quot;
  }
}</code></pre></figure></p>

<h4 id="h-52-audit-cwd-usage-in-tool-wrapperts-87" data-section="87"><span class="section-num">87</span>5.2 Audit cwd usage in tool-wrapper.ts</h4>

<p>The LSP wrapper already accepts <code>opts.cwd</code>. Verify it uses this consistently:</p>

<p><figure class="code-block" data-listing="49"><div class="code-bar"><span class="code-lang">typescript</span><button class="code-copy">copy</button></div><pre class="language-typescript"><code class="language-typescript">// packages/lsp/src/tool-wrapper.ts
import type { AgentTool } from &quot;@merlin-agents/ai&quot;;

export interface LspWrapOptions {
  cwd: string;
  onCheckStart?: () =&gt; void;
  onCheckEnd?: () =&gt; void;
}

/**
 * Wraps write and edit tools to run LSP diagnostics after execution.
 * 
 * Only wraps tools named &quot;write&quot; or &quot;edit&quot; - other tools pass through unchanged.
 */
export function wrapToolsWithLspDiagnostics(
  tools: AgentTool&lt;any, any&gt;[],
  lspManager: LspManager,
  opts: LspWrapOptions
): AgentTool&lt;any, any&gt;[] {
  return tools.map((tool) =&gt; {
    // Only wrap file-modifying tools
    if (tool.name !== &quot;write&quot; &amp;&amp; tool.name !== &quot;edit&quot;) {
      return tool;
    }

    return {
      ...tool,
      execute: async (toolCallId, params, signal, onUpdate) =&gt; {
        // Run the original tool
        const result = await tool.execute(toolCallId, params, signal, onUpdate);

        // Run LSP diagnostics
        opts.onCheckStart?.();
        try {
          // Use opts.cwd, not process.cwd()
          const diagnostics = await lspManager.getDiagnostics(
            params.path, 
            opts.cwd
          );
          
          if (diagnostics.length &gt; 0) {
            // Append diagnostics to the result
            const diagText = diagnostics
              .map(d =&gt; `${d.file}:${d.line}: ${d.message}`)
              .join(&quot;\n&quot;);
            
            return {
              ...result,
              content: [
                ...result.content,
                { type: &quot;text&quot;, text: `\n\nLSP Diagnostics:\n${diagText}` },
              ],
            };
          }
        } finally {
          opts.onCheckEnd?.();
        }

        return result;
      },
    };
  });
}</code></pre></figure></p>

<p>The key point: <code>opts.cwd</code> is already passed in and used. No changes needed if it's already correct.</p>

<h3 id="h-watch-out-for-88" data-section="88"><span class="section-num">88</span>Watch out for</h3>

<ul>
<li>The wrapper uses <code>params.path</code> which may be relative - ensure LSP manager resolves it against <code>opts.cwd</code></li>
<li>Only <code>write</code> and <code>edit</code> are wrapped, not <code>bash</code> (which could also modify files, but that's a different discussion)</li>
</ul>

<hr>

<h2 id="h-milestone-6-create-packagessdk-89" data-section="89"><span class="section-num">89</span>Milestone 6: Create <code>packages/sdk</code></h2>

<h3 id="h-goal-90" data-section="90"><span class="section-num">90</span>Goal</h3>

<p>Introduce a small SDK that exposes <code>createMerlinAgent()</code> and exports config helpers.</p>

<h3 id="h-what-this-package-does-91" data-section="91"><span class="section-num">91</span>What this package does</h3>

<ul>
<li>Provides a simple API for embedding the agent in other applications</li>
<li>Handles config loading with cwd awareness</li>
<li>Creates properly wired agents with default tools</li>
</ul>

<h3 id="h-verification-92" data-section="92"><span class="section-num">92</span>Verification</h3>

<li class="task"><span class="checkbox">[ ]</span> <code>bun run typecheck</code> for <code>packages/sdk</code> passes.</li>
<li class="task"><span class="checkbox">[ ]</span> A simple embed example can run with tools bound to a custom cwd.</li>

<h3 id="h-file-structure-93" data-section="93"><span class="section-num">93</span>File structure</h3>

<p><figure class="code-block" data-listing="50"><div class="code-bar"><span class="code-lang">text</span><button class="code-copy">copy</button></div><pre><code>packages/sdk/
 package.json
 tsconfig.json
 src/
     index.ts              # Public exports
     config.ts             # Config loading (moved from apps/coding-agent)
     merlin-agent.ts       # Agent factory</code></pre></figure></p>

<h3 id="h-steps-94" data-section="94"><span class="section-num">94</span>Steps</h3>

<h4 id="h-61-create-the-package-skeleton-95" data-section="95"><span class="section-num">95</span>6.1 Create the package skeleton</h4>

<p>Create <code>packages/sdk/package.json</code>:</p>

<p><figure class="code-block" data-listing="51"><div class="code-bar"><span class="code-lang">json</span><button class="code-copy">copy</button></div><pre class="language-json"><code class="language-json">{
  &quot;name&quot;: &quot;@merlin-agents/sdk&quot;,
  &quot;version&quot;: &quot;0.1.0&quot;,
  &quot;type&quot;: &quot;module&quot;,
  &quot;exports&quot;: {
    &quot;.&quot;: &quot;./src/index.ts&quot;
  },
  &quot;dependencies&quot;: {
    &quot;@merlin-agents/ai&quot;: &quot;file:../ai&quot;,
    &quot;@merlin-agents/agent-core&quot;: &quot;file:../agent&quot;,
    &quot;@merlin-agents/base-tools&quot;: &quot;file:../base-tools&quot;,
    &quot;@merlin-agents/lsp&quot;: &quot;file:../lsp&quot;
  },
  &quot;scripts&quot;: {
    &quot;typecheck&quot;: &quot;tsc --noEmit&quot;
  }
}</code></pre></figure></p>

<p>Create <code>packages/sdk/tsconfig.json</code>:</p>

<p><figure class="code-block" data-listing="52"><div class="code-bar"><span class="code-lang">json</span><button class="code-copy">copy</button></div><pre class="language-json"><code class="language-json">{
  &quot;extends&quot;: &quot;../../tsconfig.base.json&quot;,
  &quot;compilerOptions&quot;: {
    &quot;rootDir&quot;: &quot;./src&quot;,
    &quot;outDir&quot;: &quot;./dist&quot;
  },
  &quot;include&quot;: [&quot;src/**/*&quot;]
}</code></pre></figure></p>

<h4 id="h-62-move-config-logic-into-sdk-96" data-section="96"><span class="section-num">96</span>6.2 Move config logic into SDK</h4>

<p>Create <code>packages/sdk/src/config.ts</code>:</p>

<p><figure class="code-block" data-listing="53"><div class="code-bar"><span class="code-lang">typescript</span><button class="code-copy">copy</button></div><pre class="language-typescript"><code class="language-typescript">// packages/sdk/src/config.ts
import * as path from &quot;path&quot;;
import * as os from &quot;os&quot;;
import { readFile } from &quot;node:fs/promises&quot;;
import { existsSync } from &quot;node:fs&quot;;
import type { ThinkingLevel } from &quot;@merlin-agents/agent-core&quot;;
import { getProviders, getModels, type Model, type Api, type KnownProvider } from &quot;@merlin-agents/ai&quot;;

// ============================================================
// Path Constants - Updated for merlin
// ============================================================

/**
 * Global AGENTS.md search paths (user-wide instructions).
 * Searched in order, first found wins.
 */
const GLOBAL_AGENTS_PATHS = [
  () =&gt; path.join(os.homedir(), '.config', 'merlin', 'agents.md'),
  () =&gt; path.join(os.homedir(), '.config', 'marvin', 'agents.md'),  // Legacy
  () =&gt; path.join(os.homedir(), '.codex', 'agents.md'),             // Codex compat
  () =&gt; path.join(os.homedir(), '.claude', 'CLAUDE.md'),            // Claude compat
];

/**
 * Returns project-level AGENTS.md search paths for a given cwd.
 * 
 * @param cwd - The project working directory
 * @returns Array of path functions, searched in order
 */
const projectAgentsPaths = (cwd: string) =&gt; [
  () =&gt; path.join(cwd, 'AGENTS.md'),
  () =&gt; path.join(cwd, 'CLAUDE.md'),
];

/**
 * Returns the default config directory.
 * Changed from ~/.config/marvin to ~/.config/merlin.
 */
export const resolveConfigDir = (): string =&gt; 
  path.join(os.homedir(), '.config', 'merlin');

// ============================================================
// Types
// ============================================================

export interface AgentsConfig {
  global?: { path: string; content: string };
  project?: { path: string; content: string };
  combined: string;
}

export interface EditorConfig {
  command: string;
  args: string[];
}

export interface LoadedAppConfig {
  provider: KnownProvider;
  modelId: string;
  model: Model&lt;Api&gt;;
  thinking: ThinkingLevel;
  theme: string;
  editor?: EditorConfig;
  systemPrompt: string;
  agentsConfig: AgentsConfig;
  configDir: string;
  configPath: string;
  lsp: { enabled: boolean; autoInstall: boolean };
}

// ============================================================
// Helpers
// ============================================================

async function readFileIfExists(filePath: string): Promise&lt;string | undefined&gt; {
  try {
    return await readFile(filePath, &quot;utf-8&quot;);
  } catch {
    return undefined;
  }
}

async function readJsonIfExists(filePath: string): Promise&lt;unknown&gt; {
  const content = await readFileIfExists(filePath);
  if (content === undefined) return undefined;
  try {
    return JSON.parse(content);
  } catch {
    return undefined;
  }
}

async function loadFirstExisting(
  pathFns: Array&lt;() =&gt; string&gt;
): Promise&lt;{ path: string; content: string } | undefined&gt; {
  for (const pathFn of pathFns) {
    const p = pathFn();
    const content = await readFileIfExists(p);
    if (content !== undefined) {
      return { path: p, content };
    }
  }
  return undefined;
}

// ============================================================
// Public API
// ============================================================

/**
 * Loads AGENTS.md configuration from global and project paths.
 * 
 * @param options.cwd - Project directory for AGENTS.md lookup (default: process.cwd())
 * @returns Combined global + project instructions
 */
export const loadAgentsConfig = async (options?: { 
  cwd?: string 
}): Promise&lt;AgentsConfig&gt; =&gt; {
  const cwd = options?.cwd ?? process.cwd();
  
  const global = await loadFirstExisting(GLOBAL_AGENTS_PATHS);
  const project = await loadFirstExisting(projectAgentsPaths(cwd));

  const parts: string[] = [];
  if (global) parts.push(global.content);
  if (project) parts.push(project.content);

  return {
    global,
    project,
    combined: parts.join('\n\n---\n\n'),
  };
};

/**
 * Loads full application configuration.
 * 
 * @param options.cwd - Project directory (affects AGENTS.md loading)
 * @param options.configDir - Config directory (default: ~/.config/merlin)
 * @param options.configPath - Explicit config file path
 * @param options.provider - Override provider
 * @param options.model - Override model
 * @param options.thinking - Override thinking level
 */
export const loadAppConfig = async (options?: {
  cwd?: string;
  configDir?: string;
  configPath?: string;
  provider?: string;
  model?: string;
  thinking?: ThinkingLevel;
}): Promise&lt;LoadedAppConfig&gt; =&gt; {
  const cwd = options?.cwd ?? process.cwd();
  const configDir = options?.configDir ?? resolveConfigDir();
  const configPath = options?.configPath ?? path.join(configDir, 'config.json');

  // Load config.json
  const rawConfig = (await readJsonIfExists(configPath)) ?? {};
  const rawObj = typeof rawConfig === 'object' &amp;&amp; rawConfig !== null 
    ? (rawConfig as Record&lt;string, unknown&gt;) 
    : {};

  // Support nested { config: {...} } structure
  const nestedConfig = typeof rawObj.config === 'object' &amp;&amp; rawObj.config !== null
    ? (rawObj.config as Record&lt;string, unknown&gt;)
    : {};

  // Resolve provider (CLI &gt; nested &gt; top-level)
  const providerRaw = options?.provider ??
    (typeof nestedConfig.provider === 'string' ? nestedConfig.provider : undefined) ??
    (typeof rawObj.provider === 'string' ? rawObj.provider : undefined);

  const provider = resolveProvider(providerRaw);
  if (!provider) {
    throw new Error(`Invalid or missing provider: ${providerRaw}`);
  }

  // Resolve model
  const modelIdRaw = options?.model ??
    (typeof nestedConfig.model === 'string' ? nestedConfig.model : undefined) ??
    (typeof rawObj.model === 'string' ? rawObj.model : undefined);

  const model = resolveModel(provider, modelIdRaw);
  if (!model) {
    throw new Error(`Invalid or missing model: ${modelIdRaw}`);
  }

  // Resolve other settings
  const thinking: ThinkingLevel = options?.thinking ??
    (typeof nestedConfig.thinking === 'string' ? nestedConfig.thinking as ThinkingLevel : undefined) ??
    (typeof rawObj.thinking === 'string' ? rawObj.thinking as ThinkingLevel : undefined) ??
    'off';

  // Theme default changed from 'marvin' to 'merlin'
  const theme: string = 
    (typeof rawObj.theme === 'string' ? rawObj.theme : undefined) ?? 'merlin';

  // LSP settings
  const lspRaw = typeof rawObj.lsp === 'object' &amp;&amp; rawObj.lsp !== null
    ? (rawObj.lsp as Record&lt;string, unknown&gt;)
    : {};
  const lsp = {
    enabled: typeof lspRaw.enabled === 'boolean' ? lspRaw.enabled : true,
    autoInstall: typeof lspRaw.autoInstall === 'boolean' ? lspRaw.autoInstall : true,
  };

  // Load and merge AGENTS.md - NOW WITH CWD PARAMETER
  const agentsConfig = await loadAgentsConfig({ cwd });

  // Build system prompt
  const basePrompt = typeof rawObj.systemPrompt === 'string' &amp;&amp; rawObj.systemPrompt.trim().length &gt; 0
    ? rawObj.systemPrompt
    : 'You are a helpful coding agent. Use tools (read, bash, edit, write) when needed.';

  const systemPrompt = agentsConfig.combined
    ? `${basePrompt}\n\n${agentsConfig.combined}`
    : basePrompt;

  return {
    provider,
    modelId: model.id,
    model,
    thinking,
    theme,
    systemPrompt,
    agentsConfig,
    configDir,
    configPath,
    lsp,
  };
};

function resolveProvider(providerRaw: string | undefined): KnownProvider | undefined {
  const providers = getProviders();
  if (!providerRaw) {
    // Default to first available provider
    return providers[0];
  }
  return providers.find(p =&gt; p === providerRaw);
}

function resolveModel(provider: KnownProvider, modelIdRaw: string | undefined): Model&lt;Api&gt; | undefined {
  const models = getModels(provider);
  if (!modelIdRaw) {
    // Default to first model for provider
    return models[0];
  }
  return models.find(m =&gt; m.id === modelIdRaw);
}</code></pre></figure></p>

<h4 id="h-63-implement-the-sdk-agent-factory-97" data-section="97"><span class="section-num">97</span>6.3 Use the Effect SDK surface</h4><p>This repo uses <code>@marvin-agents/sdk</code> built on <code>packages/runtime-effect</code>. Do not implement a custom agent factory inside the SDK; use the provided surface instead.</p><ul><li><code>runAgent</code> / <code>runAgentEffect</code></li><li><code>createAgentSession</code> / <code>createAgentSessionEffect</code></li><li><code>runAgentStream</code></li></ul><p>See <code>docs/sdk.md</code> for examples.</p><h4 id="h-64-re-export-sdk-surface-98" data-section="98"><span class="section-num">98</span>6.4 Re-export SDK surface</h4>

<p>Create <code>packages/sdk/src/index.ts</code>:</p>

<p><figure class="code-block" data-listing="57"><div class="code-bar"><span class="code-lang">typescript</span><button class="code-copy">copy</button></div><pre class="language-typescript"><code class="language-typescript">// packages/sdk/src/index.ts

// Main factory
export { 
  createMerlinAgent, 
  type MerlinAgentOptions, 
  type MerlinAgent 
} from &quot;./merlin-agent.js&quot;;

// Config utilities
export { 
  loadAgentsConfig, 
  loadAppConfig, 
  resolveConfigDir,
  type AgentsConfig,
  type LoadedAppConfig,
  type EditorConfig,
} from &quot;./config.js&quot;;

// Re-export key types from dependencies
export type { Agent, ThinkingLevel } from &quot;@merlin-agents/agent-core&quot;;
export type { AgentTool, AgentToolResult, TextContent, ImageContent, Model, Api, KnownProvider } from &quot;@merlin-agents/ai&quot;;
export { createToolRegistry, createReadTool, createWriteTool, createEditTool, createBashTool } from &quot;@merlin-agents/base-tools&quot;;</code></pre></figure></p>

<h4 id="h-65-update-root-typecheck-script-99" data-section="99"><span class="section-num">99</span>6.5 Update root typecheck script</h4>

<p>Add <code>packages/sdk/tsconfig.json</code> to the root <code>typecheck</code> path in <code>package.json</code> workspaces.</p>

<h3 id="h-watch-out-for-100" data-section="100"><span class="section-num">100</span>Watch out for</h3>

<ul>
<li><strong>SDK should NOT auto-load hooks or custom tools</strong> - that's CLI-specific behavior</li>
<li>All cwd-dependent APIs should accept an optional <code>cwd</code> parameter</li>
<li>The <code>close()</code> function is important - users must call it to clean up LSP processes</li>
</ul>

<hr>

<h2 id="h-milestone-7-migrate-packagesopen-tui-if-keeping-the-cli-101" data-section="101"><span class="section-num">101</span>Milestone 7: Migrate <code>packages/open-tui</code> (if keeping the CLI)</h2>

<h3 id="h-goal-102" data-section="102"><span class="section-num">102</span>Goal</h3>

<p>Move the UI package unchanged and make sure callers pass explicit cwd to autocomplete.</p>

<h3 id="h-verification-103" data-section="103"><span class="section-num">103</span>Verification</h3>

<li class="task"><span class="checkbox">[ ]</span> <code>bun run typecheck</code> for <code>packages/open-tui</code> passes.</li>

<h3 id="h-file-checklist-104" data-section="104"><span class="section-num">104</span>File checklist</h3>

<p><figure class="code-block" data-listing="58"><div class="code-bar"><span class="code-lang">text</span><button class="code-copy">copy</button></div><pre><code>packages/open-tui/
 package.json
 tsconfig.json
 src/
     index.ts
     autocomplete/
        autocomplete.ts    # Has process.cwd() default
     context/
         theme.tsx          # Default theme name</code></pre></figure></p>

<h3 id="h-steps-105" data-section="105"><span class="section-num">105</span>Steps</h3>

<h4 id="h-71-update-package-metadata-106" data-section="106"><span class="section-num">106</span>7.1 Update package metadata</h4>

<p>Edit <code>packages/open-tui/package.json</code>:</p>

<p><figure class="code-block" data-listing="59"><div class="code-bar"><span class="code-lang">json</span><button class="code-copy">copy</button></div><pre class="language-json"><code class="language-json">{
  &quot;name&quot;: &quot;@merlin-agents/open-tui&quot;,
  &quot;version&quot;: &quot;0.1.0&quot;,
  &quot;type&quot;: &quot;module&quot;,
  &quot;exports&quot;: {
    &quot;.&quot;: &quot;./src/index.ts&quot;
  },
  &quot;dependencies&quot;: {
    &quot;solid-js&quot;: &quot;^1.9.5&quot;
  },
  &quot;scripts&quot;: {
    &quot;typecheck&quot;: &quot;tsc --noEmit&quot;
  }
}</code></pre></figure></p>

<h4 id="h-72-audit-combinedautocompleteprovider-107" data-section="107"><span class="section-num">107</span>7.2 Audit <code>CombinedAutocompleteProvider</code></h4>

<p>The autocomplete uses a <code>basePath</code> that defaults to <code>process.cwd()</code>:</p>

<p><figure class="code-block" data-listing="60"><div class="code-bar"><span class="code-lang">typescript</span><button class="code-copy">copy</button></div><pre class="language-typescript"><code class="language-typescript">// packages/open-tui/src/autocomplete/autocomplete.ts
export interface AutocompleteOptions {
  basePath?: string;  // Defaults to process.cwd() if not provided
}

export function createAutocomplete(options?: AutocompleteOptions) {
  const basePath = options?.basePath ?? process.cwd();
  // ...
}</code></pre></figure></p>

<p>This is fine as a default, but the CLI should always pass <code>cwd</code> explicitly:</p>

<p><figure class="code-block" data-listing="61"><div class="code-bar"><span class="code-lang">typescript</span><button class="code-copy">copy</button></div><pre class="language-typescript"><code class="language-typescript">// In tui-app.tsx
const autocomplete = createAutocomplete({ 
  basePath: cwd  // Always pass explicitly!
});</code></pre></figure></p>

<h4 id="h-73-rename-the-built-in-default-theme-108" data-section="108"><span class="section-num">108</span>7.3 Rename the built-in default theme</h4>

<p>Find the default theme definition and rename:</p>

<p><figure class="code-block" data-listing="62"><div class="code-bar"><span class="code-lang">typescript</span><button class="code-copy">copy</button></div><pre class="language-typescript"><code class="language-typescript">// packages/open-tui/src/context/theme.tsx

// Find this:
const defaultDarkTheme: Theme = {
  name: &quot;marvin&quot;,
  // ...
};

// Change to:
const defaultDarkTheme: Theme = {
  name: &quot;merlin&quot;,
  // ...
};

// Also update availableThemes():
export function availableThemes(): string[] {
  return [
    &quot;merlin&quot;,  // Default, was &quot;marvin&quot;
    &quot;dark&quot;,
    &quot;light&quot;,
    // ... other themes
  ];
}</code></pre></figure></p>

<p>Keep the actual color values unchanged - only the name changes.</p>

<h3 id="h-watch-out-for-109" data-section="109"><span class="section-num">109</span>Watch out for</h3>

<ul>
<li><code>solid-js</code> version must match the root <code>overrides</code> in package.json</li>
<li>The TUI has many files - focus only on the cwd-related changes for now</li>
</ul>

<hr>

<h2 id="h-milestone-8-migrate-appscoding-agent-and-dogfood-sdk-110" data-section="110"><span class="section-num">110</span>Milestone 8: Migrate <code>apps/coding-agent</code> and dogfood SDK</h2>

<h3 id="h-goal-111" data-section="111"><span class="section-num">111</span>Goal</h3>

<p>Rebuild the CLI as a consumer of the SDK while keeping all existing features.</p>

<h3 id="h-verification-112" data-section="112"><span class="section-num">112</span>Verification</h3>

<li class="task"><span class="checkbox">[ ]</span> <code>bun run typecheck</code> for the app passes.</li>
<li class="task"><span class="checkbox">[ ]</span> <code>bun run merlin --help</code> works.</li>
<li class="task"><span class="checkbox">[ ]</span> <code>bun run merlin --headless &quot;echo test&quot;</code> works.</li>

<h3 id="h-file-checklist-113" data-section="113"><span class="section-num">113</span>File checklist</h3>

<p>These are the key files that need updates:</p>

<p><figure class="code-block" data-listing="63"><div class="code-bar"><span class="code-lang">text</span><button class="code-copy">copy</button></div><pre><code>apps/coding-agent/
 package.json               # Rename package, update bin
 scripts/build.ts           # Update output path
 src/
    index.ts              # Rename all marvin strings
    headless.ts           # Use SDK
    tui-app.tsx           # Use SDK
    config.ts             # Re-export from SDK
    session-manager.ts    # Add cwd parameter
    profiler.ts           # Rename env vars
    theme-names.ts        # Update default theme
    hooks/
       types.ts          # Update docs
       loader.ts         # Update paths
    custom-tools/
        loader.ts         # Update paths
 examples/
     auto-compact.ts       # Rename env vars</code></pre></figure></p>

<h3 id="h-steps-114" data-section="114"><span class="section-num">114</span>Steps</h3>

<h4 id="h-81-update-packagejson-115" data-section="115"><span class="section-num">115</span>8.1 Update package.json</h4>

<p><figure class="code-block" data-listing="64"><div class="code-bar"><span class="code-lang">json</span><button class="code-copy">copy</button></div><pre class="language-json"><code class="language-json">{
  &quot;name&quot;: &quot;@merlin-agents/coding-agent&quot;,
  &quot;version&quot;: &quot;0.1.0&quot;,
  &quot;type&quot;: &quot;module&quot;,
  &quot;bin&quot;: {
    &quot;merlin&quot;: &quot;./src/index.ts&quot;
  },
  &quot;exports&quot;: {
    &quot;.&quot;: &quot;./src/index.ts&quot;,
    &quot;./hooks&quot;: &quot;./src/hooks/index.ts&quot;
  },
  &quot;dependencies&quot;: {
    &quot;@merlin-agents/sdk&quot;: &quot;file:../../packages/sdk&quot;,
    &quot;@merlin-agents/open-tui&quot;: &quot;file:../../packages/open-tui&quot;,
    &quot;@merlin-agents/lsp&quot;: &quot;file:../../packages/lsp&quot;
  },
  &quot;scripts&quot;: {
    &quot;typecheck&quot;: &quot;tsc --noEmit&quot;,
    &quot;build&quot;: &quot;bun scripts/build.ts&quot;
  }
}</code></pre></figure></p>

<h4 id="h-82-update-buildts-116" data-section="116"><span class="section-num">116</span>8.2 Update build.ts</h4>

<p><figure class="code-block" data-listing="65"><div class="code-bar"><span class="code-lang">typescript</span><button class="code-copy">copy</button></div><pre class="language-typescript"><code class="language-typescript">// apps/coding-agent/scripts/build.ts
#!/usr/bin/env bun
/**
 * Build script for merlin CLI
 * 
 * Single-step compile with Solid plugin - assets are embedded automatically.
 */
import solidPlugin from &quot;@opentui/solid/bun-plugin&quot;;
import { readdirSync, realpathSync } from &quot;node:fs&quot;;
import { dirname, join, relative } from &quot;node:path&quot;;
import { fileURLToPath } from &quot;node:url&quot;;

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
const projectRoot = join(__dirname, &quot;..&quot;);
const workspaceRoot = join(__dirname, &quot;../../..&quot;);

// Changed from &quot;marvin&quot; to &quot;merlin&quot;
const outfile = process.argv[2] || join(process.env.HOME!, &quot;commands&quot;, &quot;merlin&quot;);

// ... rest of build script unchanged</code></pre></figure></p>

<h4 id="h-83-apply-rename-sweep-in-indexts-117" data-section="117"><span class="section-num">117</span>8.3 Apply rename sweep in index.ts</h4>

<p>Find and replace all occurrences:</p>

<p><figure class="code-block" data-listing="66"><div class="code-bar"><span class="code-lang">typescript</span><button class="code-copy">copy</button></div><pre class="language-typescript"><code class="language-typescript">// apps/coding-agent/src/index.ts

// In printHelp():
const help = `
Usage:
  merlin [options] [prompt...]

Options:
  --headless                   Run in headless mode (single prompt, JSON output)
  --provider &lt;name&gt;            LLM provider (anthropic, openai, google, codex)
  --model &lt;id&gt;                 Model ID
  --thinking &lt;level&gt;           Thinking level (off, minimal, low, medium, high, xhigh)
  --config-dir &lt;dir&gt;           Config directory (default: ~/.config/merlin)
  --config &lt;path&gt;              Config file path
  --acp                        Run as ACP server (Zed integration)
  --continue, -c               Continue last session
  --resume                     Pick a session to resume
  --version, -v                Show version
  --help, -h                   Show this help

Custom commands:
  Create ~/.config/merlin/commands/&lt;name&gt;.ts exporting (api) =&gt; ({ ... })

Custom hooks:
  Create ~/.config/merlin/hooks/&lt;name&gt;.ts exporting:
    export default function(merlin) { merlin.on(event, handler) }

  Events: app.start, session.start, session.resume, session.clear,
          agent.start, agent.end, turn.start, turn.end,
          tool.execute.before, tool.execute.after

  Use merlin.send(text) to inject messages into conversation.

Custom tools:
  Create ~/.config/merlin/tools/&lt;name&gt;.ts exporting:
    export default function(api) { return { name, description, parameters, execute } }
`;</code></pre></figure></p>

<h4 id="h-84-update-profilerts-118" data-section="118"><span class="section-num">118</span>8.4 Update profiler.ts</h4>

<p><figure class="code-block" data-listing="67"><div class="code-bar"><span class="code-lang">typescript</span><button class="code-copy">copy</button></div><pre class="language-typescript"><code class="language-typescript">// apps/coding-agent/src/profiler.ts
export function isProfilingEnabled(): boolean {
  // Changed from MARVIN_TUI_PROFILE to MERLIN_TUI_PROFILE
  return process.env.MERLIN_TUI_PROFILE === &quot;1&quot;;
}</code></pre></figure></p>

<h4 id="h-85-update-theme-namests-119" data-section="119"><span class="section-num">119</span>8.5 Update theme-names.ts</h4>

<p><figure class="code-block" data-listing="68"><div class="code-bar"><span class="code-lang">typescript</span><button class="code-copy">copy</button></div><pre class="language-typescript"><code class="language-typescript">// apps/coding-agent/src/theme-names.ts
/**
 * Available theme names.
 * &quot;merlin&quot; is the built-in default theme.
 */
export const THEME_NAMES = [
  &quot;merlin&quot;,  // Changed from &quot;marvin&quot;
  &quot;dark&quot;,
  &quot;light&quot;,
  // ... other themes
];

export const DEFAULT_THEME = &quot;merlin&quot;;</code></pre></figure></p>

<h4 id="h-86-update-hooksloaderts-120" data-section="120"><span class="section-num">120</span>8.6 Update hooks/loader.ts</h4>

<p><figure class="code-block" data-listing="69"><div class="code-bar"><span class="code-lang">typescript</span><button class="code-copy">copy</button></div><pre class="language-typescript"><code class="language-typescript">// apps/coding-agent/src/hooks/loader.ts
/**
 * Loads hooks from ~/.config/merlin/hooks/*.ts
 */
export async function loadHooks(configDir: string): Promise&lt;LoadedHook[]&gt; {
  const hooksDir = path.join(configDir, &quot;hooks&quot;);
  // ...
}</code></pre></figure></p>

<h4 id="h-87-update-custom-toolsloaderts-121" data-section="121"><span class="section-num">121</span>8.7 Update custom-tools/loader.ts</h4>

<p><figure class="code-block" data-listing="70"><div class="code-bar"><span class="code-lang">typescript</span><button class="code-copy">copy</button></div><pre class="language-typescript"><code class="language-typescript">// apps/coding-agent/src/custom-tools/loader.ts
/**
 * Loads custom tools from ~/.config/merlin/tools/*.ts
 */
export async function loadCustomTools(
  configDir: string,
  cwd: string,
  builtInToolNames: string[],
  sendRef: SendRef
): Promise&lt;CustomToolsLoadResult&gt; {
  const toolsDir = path.join(configDir, &quot;tools&quot;);
  // ...
}</code></pre></figure></p>

<h4 id="h-88-update-hookstypests-122" data-section="122"><span class="section-num">122</span>8.8 Update hooks/types.ts</h4>

<p><figure class="code-block" data-listing="71"><div class="code-bar"><span class="code-lang">typescript</span><button class="code-copy">copy</button></div><pre class="language-typescript"><code class="language-typescript">// apps/coding-agent/src/hooks/types.ts
/**
 * Hook API provided to hook factories.
 * 
 * @example
 *</code></pre></figure>typescript<br> <em> import type { HookFactory } from &quot;@merlin-agents/coding-agent/hooks&quot;;<br> </em> <br> <em> const hook: HookFactory = (merlin) =&gt; {<br> </em>   merlin.on(&quot;agent.start&quot;, () =&gt; {<br> <em>     merlin.send(&quot;Hello!&quot;);<br> </em>   });<br> <em> };<br> </em> <br> <em> export default hook;<br> </em> <figure class="code-block" data-listing="72"><div class="code-bar"><span class="code-lang">text</span><button class="code-copy">copy</button></div><pre><code>*/
export interface HookAPI {
  // ...
}</code></pre></figure></p>

<h4 id="h-89-convert-configts-to-re-export-123" data-section="123"><span class="section-num">123</span>8.9 Convert config.ts to re-export</h4>

<p><figure class="code-block" data-listing="73"><div class="code-bar"><span class="code-lang">typescript</span><button class="code-copy">copy</button></div><pre class="language-typescript"><code class="language-typescript">// apps/coding-agent/src/config.ts
// Re-export from SDK - app no longer owns config logic
export { 
  loadAgentsConfig, 
  loadAppConfig, 
  resolveConfigDir,
  type AgentsConfig,
  type LoadedAppConfig,
  type EditorConfig,
} from &quot;@merlin-agents/sdk&quot;;

// App-specific config updates can stay here
export { updateAppConfig } from &quot;./config-updates.js&quot;;</code></pre></figure></p>

<h4 id="h-810-update-headlessts-to-use-sdk-124" data-section="124"><span class="section-num">124</span>8.10 Update headless.ts to use SDK</h4>

<p><figure class="code-block" data-listing="74"><div class="code-bar"><span class="code-lang">typescript</span><button class="code-copy">copy</button></div><pre class="language-typescript"><code class="language-typescript">// apps/coding-agent/src/headless.ts
import { createMerlinAgent } from &quot;@merlin-agents/sdk&quot;;
import { loadTokens, saveTokens, clearTokens } from &quot;@merlin-agents/agent-core&quot;;
import { loadHooks, HookRunner, wrapToolsWithHooks } from &quot;./hooks/index.js&quot;;
import { loadCustomTools } from &quot;./custom-tools/index.js&quot;;

export async function runHeadless(options: {
  prompt: string;
  configDir?: string;
  configPath?: string;
  provider?: string;
  model?: string;
  thinking?: ThinkingLevel;
}) {
  const cwd = process.cwd();
  
  // Use SDK to create base agent
  const { agent, config, close } = await createMerlinAgent({
    cwd,
    configDir: options.configDir,
    configPath: options.configPath,
    provider: options.provider,
    model: options.model,
    thinking: options.thinking,
    // Provide Codex token management
    codex: {
      getTokens: async () =&gt; loadTokens({ configDir: config.configDir }),
      setTokens: async (tokens) =&gt; saveTokens(tokens, { configDir: config.configDir }),
      clearTokens: async () =&gt; clearTokens({ configDir: config.configDir }),
    },
    // Custom tool handling stays in CLI layer
    tools: async (defaults) =&gt; {
      // Load hooks
      const hooks = await loadHooks(config.configDir);
      const hookRunner = new HookRunner(hooks, { cwd, configDir: config.configDir });
      
      // Load custom tools (sendRef is no-op in headless)
      const sendRef = { current: () =&gt; {} };
      const { tools: customTools } = await loadCustomTools(
        config.configDir,
        cwd,
        defaults.map(t =&gt; t.name),
        sendRef
      );
      
      // Combine and wrap with hooks
      const allTools = [...defaults, ...customTools.map(t =&gt; t.tool)];
      return wrapToolsWithHooks(allTools, hookRunner);
    },
  });

  try {
    // Run the prompt
    const result = await agent.prompt(options.prompt);
    
    // Output as JSON
    process.stdout.write(JSON.stringify(result, null, 2) + &quot;\n&quot;);
  } finally {
    await close();
  }
}</code></pre></figure></p>

<h4 id="h-811-update-session-managerts-125" data-section="125"><span class="section-num">125</span>8.11 Update session-manager.ts</h4>

<p>Add explicit cwd parameter:</p>

<p><figure class="code-block" data-listing="75"><div class="code-bar"><span class="code-lang">typescript</span><button class="code-copy">copy</button></div><pre class="language-typescript"><code class="language-typescript">// apps/coding-agent/src/session-manager.ts
export class SessionManager {
  private configDir: string;
  private cwd: string;
  private sessionDir: string;

  constructor(options: { 
    configDir?: string; 
    cwd?: string;  // NEW: Explicit cwd parameter
  } = {}) {
    // Changed default from ~/.config/marvin to ~/.config/merlin
    this.configDir = options.configDir ?? join(process.env.HOME || '', '.config', 'merlin');
    this.cwd = options.cwd ?? process.cwd();  // Now can be passed explicitly
    this.sessionDir = join(this.configDir, 'sessions', safeCwd(this.cwd));
  }

  // ... rest unchanged
}</code></pre></figure></p>

<h4 id="h-812-update-examples-126" data-section="126"><span class="section-num">126</span>8.12 Update examples</h4>

<p><figure class="code-block" data-listing="76"><div class="code-bar"><span class="code-lang">typescript</span><button class="code-copy">copy</button></div><pre class="language-typescript"><code class="language-typescript">// apps/coding-agent/examples/auto-compact.ts
// Changed from MARVIN_COMPACT_THRESHOLD to MERLIN_COMPACT_THRESHOLD
const threshold = parseInt(process.env.MERLIN_COMPACT_THRESHOLD ?? &quot;80&quot;, 10);</code></pre></figure></p>

<h4 id="h-813-update-acpindexts-127" data-section="127"><span class="section-num">127</span>8.13 Update acp/index.ts</h4>

<p><figure class="code-block" data-listing="77"><div class="code-bar"><span class="code-lang">typescript</span><button class="code-copy">copy</button></div><pre class="language-typescript"><code class="language-typescript">// apps/coding-agent/src/acp/index.ts
// Change agent name from &quot;Marvin&quot; to &quot;Merlin&quot;
const ACP_AGENT_INFO = {
  name: &quot;Merlin&quot;,
  version: pkg.version,
  // ...
};</code></pre></figure></p>

<h3 id="h-watch-out-for-128" data-section="128"><span class="section-num">128</span>Watch out for</h3>

<ul>
<li>The TUI render pipeline is complex - don't change it while migrating</li>
<li>Build script requires the Solid plugin - use <code>bun run build</code> not <code>bun build --compile</code></li>
<li>The <code>sendRef</code> pattern allows late binding - don't break this</li>
</ul>

<hr>

<h2 id="h-milestone-9-legacy-compatibility-optional-129" data-section="129"><span class="section-num">129</span>Milestone 9: Legacy compatibility (removed)</h2><p>Legacy compatibility is out of scope for this repo. Do not add legacy config detection, migration commands, or legacy token paths.</p><h2 id="h-testing-strategy-137" data-section="137"><span class="section-num">137</span>Testing strategy</h2>

<h3 id="h-package-level-checks-138" data-section="138"><span class="section-num">138</span>Package-level checks</h3>

<p>After each package is migrated:</p>

<p><figure class="code-block" data-listing="80"><div class="code-bar"><span class="code-lang">bash</span><button class="code-copy">copy</button></div><pre class="language-bash"><code class="language-bash"># Typecheck everything
bun run typecheck

# Run all tests
bun run test</code></pre></figure></p>

<h3 id="h-sdk-manual-checks-139" data-section="139"><span class="section-num">139</span>SDK manual checks</h3>

<p>Create a test script <code>test-sdk.ts</code>:</p>

<p><figure class="code-block" data-listing="81"><div class="code-bar"><span class="code-lang">typescript</span><button class="code-copy">copy</button></div><pre class="language-typescript"><code class="language-typescript">// test-sdk.ts
import { createMerlinAgent } from &quot;@merlin-agents/sdk&quot;;
import { mkdirSync, writeFileSync, rmSync } from &quot;fs&quot;;
import { join } from &quot;path&quot;;
import { tmpdir } from &quot;os&quot;;

async function main() {
  // Create a temp project directory
  const projectDir = join(tmpdir(), `merlin-test-${Date.now()}`);
  mkdirSync(projectDir, { recursive: true });
  writeFileSync(join(projectDir, &quot;test.txt&quot;), &quot;Hello, world!&quot;);

  console.log(&quot;Testing SDK with cwd:&quot;, projectDir);

  const { agent, config, close } = await createMerlinAgent({
    cwd: projectDir,
  });

  console.log(&quot;Config loaded:&quot;);
  console.log(&quot;  Provider:&quot;, config.provider);
  console.log(&quot;  Model:&quot;, config.modelId);
  console.log(&quot;  ConfigDir:&quot;, config.configDir);

  // Test that read tool works with the bound cwd
  // (This would require an actual LLM call in production)
  console.log(&quot;Agent created successfully!&quot;);

  await close();
  rmSync(projectDir, { recursive: true });
  console.log(&quot;Test complete!&quot;);
}

main().catch(console.error);</code></pre></figure></p>

<p>Run with:<br><figure class="code-block" data-listing="82"><div class="code-bar"><span class="code-lang">bash</span><button class="code-copy">copy</button></div><pre class="language-bash"><code class="language-bash">bun run test-sdk.ts</code></pre></figure></p>

<h3 id="h-cli-manual-checks-140" data-section="140"><span class="section-num">140</span>CLI manual checks</h3>

<p><figure class="code-block" data-listing="83"><div class="code-bar"><span class="code-lang">bash</span><button class="code-copy">copy</button></div><pre class="language-bash"><code class="language-bash"># Help should work
bun run merlin --help

# Headless mode
bun run merlin --headless &quot;echo test&quot;

# TUI mode (interactive)
bun run merlin
# Then: open autocomplete, verify file suggestions are from current directory</code></pre></figure></p>

<hr>

<h2 id="h-troubleshooting-quick-hits-141" data-section="141"><span class="section-num">141</span>Troubleshooting quick hits</h2>

<h3 id="h-typescript-errors-142" data-section="142"><span class="section-num">142</span>TypeScript Errors</h3>

<strong>Missing generated models:</strong>
<figure class="code-block" data-listing="84"><div class="code-bar"><span class="code-lang">bash</span><button class="code-copy">copy</button></div><pre class="language-bash"><code class="language-bash">cd packages/ai
bun run generate-models</code></pre></figure>

<strong>Import path errors after rename:</strong>
<ul>
<li>Check all <code>@marvin-agents/<em></code> imports are changed to <code>@merlin-agents/</em></code></li>
<li>Check <code>file:../</code> paths in package.json dependencies</li>
</ul>

<h3 id="h-runtime-errors-143" data-section="143"><span class="section-num">143</span>Runtime Errors</h3>

<strong>Codex instructions fail to cache:</strong>
<ul>
<li>Check <code>~/.merlin/cache</code> exists and is writable</li>
<li>Check network connectivity to GitHub</li>
</ul>

<strong>LSP diagnostics not appearing:</strong>
<ul>
<li>Ensure <code>wrapToolsWithLspDiagnostics</code> wraps <code>write</code> and <code>edit</code> tools</li>
<li>Check that wrapping order is: hooks first, then LSP</li>
</ul>

<strong>Session not saving:</strong>
<ul>
<li>Check <code>~/.config/merlin/sessions/</code> exists</li>
<li>Check file permissions</li>
</ul>

<h3 id="h-build-errors-144" data-section="144"><span class="section-num">144</span>Build Errors</h3>

<strong>Solid plugin error:</strong>
<ul>
<li>Must use <code>bun run build</code>, not <code>bun build --compile</code> directly</li>
<li>Check <code>@opentui/solid/bun-plugin</code> is installed</li>
</ul>

<strong>Binary output wrong location:</strong>
<ul>
<li>Default is <code>~/commands/merlin</code></li>
<li>Override with: <code>bun run build /path/to/output</code></li>
</ul>

<hr>

<h2 id="h-beyond-the-basics-optional-enhancements-145" data-section="145"><span class="section-num">145</span>Beyond the basics (optional enhancements)</h2>

<ol>
<li><strong>Add tests for cwd-bound tools</strong> - Create temp directories, verify paths resolve correctly</li>
<li><strong>Add explicit cwd support to HookRunner</strong> - For embedding hooks in SDK later</li>
<li><strong>Add SDK example package</strong> - Demonstrate embedding in a separate repo</li>
<li><strong>Add config validation</strong> - TypeBox schemas for config.json</li>
<li><strong>Add telemetry opt-in</strong> - For usage analytics</li>
</ol>

<hr>

<h2 id="h-quick-reference-146" data-section="146"><span class="section-num">146</span>Quick reference</h2>

<h3 id="h-commands-you-will-use-147" data-section="147"><span class="section-num">147</span>Commands you will use</h3>

<p><figure class="code-block" data-listing="85"><div class="code-bar"><span class="code-lang">bash</span><button class="code-copy">copy</button></div><pre class="language-bash"><code class="language-bash"># Install dependencies
bun install

# Typecheck everything  
bun run typecheck

# Run all tests
bun run test

# Run CLI in dev mode
bun run merlin --help
bun run merlin --headless &quot;echo test&quot;

# Build binary
cd apps/coding-agent &amp;&amp; bun run build</code></pre></figure></p>

<h3 id="h-files-you-will-touch-most-148" data-section="148"><span class="section-num">148</span>Files you will touch most</h3>

<ol>
<li><code>packages/base-tools/src/tools/path-utils.ts</code> - CWD resolution</li>
<li><code>packages/base-tools/src/tools/read.ts</code> - Read tool factory</li>
<li><code>packages/base-tools/src/tools/write.ts</code> - Write tool factory  </li>
<li><code>packages/base-tools/src/tools/edit.ts</code> - Edit tool factory</li>
<li><code>packages/base-tools/src/tools/bash.ts</code> - Bash tool factory</li>
<li><code>packages/sdk/src/config.ts</code> - Config loading</li>
<li><code>packages/sdk/src/merlin-agent.ts</code> - Agent factory</li>
<li><code>apps/coding-agent/src/index.ts</code> - CLI entrypoint</li>
<li><code>apps/coding-agent/src/headless.ts</code> - Headless mode</li>
<li><code>apps/coding-agent/src/tui-app.tsx</code> - TUI mode</li>
<li><code>apps/coding-agent/package.json</code> - Package config</li>
<li><code>apps/coding-agent/scripts/build.ts</code> - Build script</li>
<li><code>packages/agent/src/codex-auth-cli.ts</code> - Token storage</li>
</ol>

<h3 id="h-useful-references-in-the-old-repo-149" data-section="149"><span class="section-num">149</span>Useful references in the old repo</h3>

<ul>
<li><code>apps/coding-agent/src/config.ts</code> - Config parsing and AGENTS.md merge</li>
<li><code>apps/coding-agent/src/index.ts</code> - CLI usage text and help output</li>
<li><code>apps/coding-agent/src/tui-app.tsx</code> - Full wiring path</li>
<li><code>packages/base-tools/src/index.ts</code> - Tool export shape</li>
<li><code>packages/agent/src/transports/CodexTransport.ts</code> - Transport wiring</li>
<li><code>packages/open-tui/src/context/theme.tsx</code> - Built-in theme name and defaults</li>
</ul></article>
</main>
</div>

<div class="kb">
  <span><kbd>j</kbd><kbd>k</kbd> sections</span>
  <span><kbd>c</kbd> code</span>
  <span><kbd>t</kbd> toc</span>
  <span><kbd>f</kbd> font</span>
  <span><kbd>d</kbd> theme</span>
  <span><kbd>?</kbd> help</span>
</div>

<div class="help" id="help">
  <div class="help-box">
    <div class="help-title">Keyboard Shortcuts</div>
    <div class="help-row"><span><kbd>j</kbd> / <kbd>k</kbd></span><span>Next / prev section</span></div>
    <div class="help-row"><span><kbd>c</kbd></span><span>Next code block</span></div>
    <div class="help-row"><span><kbd>shift</kbd>+<kbd>c</kbd></span><span>Prev code block</span></div>
    <div class="help-row"><span><kbd>t</kbd></span><span>Toggle TOC</span></div>
    <div class="help-row"><span><kbd>f</kbd></span><span>Cycle fonts</span></div>
    <div class="help-row"><span><kbd>d</kbd></span><span>Toggle theme</span></div>
    <div class="help-row"><span><kbd>g</kbd> <kbd>g</kbd></span><span>Go to top</span></div>
    <div class="help-row"><span><kbd>shift</kbd>+<kbd>g</kbd></span><span>Go to bottom</span></div>
    <div class="help-row"><span><kbd>esc</kbd></span><span>Close</span></div>
  </div>
</div>

<script>
(function(){
const sections = Array.from(document.querySelectorAll('.prose [data-section]'));
const codes = Array.from(document.querySelectorAll('.code-block'));
const tocLinks = document.querySelectorAll('.toc-link');
const tocDots = document.querySelectorAll('.toc-dot');
const toc = document.getElementById('toc');
const help = document.getElementById('help');
const fontBtn = document.getElementById('fontBtn');
const total = 149;
let cur = 1, gWait = false;

// Fonts
const fonts = [
  { id: 'departure', name: 'Departure' },
  { id: 'plex', name: 'IBM Plex' },
  { id: 'inter', name: 'Inter' },
  { id: 'source', name: 'Source Sans' },
  { id: 'crimson', name: 'Crimson' }
];
let fontIdx = 0;

function setFont(idx) {
  fontIdx = idx % fonts.length;
  document.documentElement.dataset.font = fonts[fontIdx].id;
  fontBtn.textContent = fonts[fontIdx].name;
  try { localStorage.setItem('md-font', fonts[fontIdx].id); } catch(e) {}
}

// Load saved
try {
  const sf = localStorage.getItem('md-font');
  if (sf) { const i = fonts.findIndex(f => f.id === sf); if (i >= 0) setFont(i); }
  const st = localStorage.getItem('md-theme');
  if (st) document.documentElement.dataset.theme = st;
} catch(e) {}

fontBtn.onclick = () => setFont(fontIdx + 1);

function update() {
  const y = scrollY, h = document.documentElement.scrollHeight - innerHeight;
  const pct = h > 0 ? Math.min(100, Math.round(y / h * 100)) : 0;
  document.getElementById('progress').style.width = pct + '%';
  document.getElementById('pct').textContent = pct + '%';
  
  let active = 1;
  for (const s of sections) if (s.getBoundingClientRect().top <= 80) active = +s.dataset.section || active;
  if (active !== cur) {
    cur = active;
    document.getElementById('pos').textContent = cur + ' / ' + total;
    tocLinks.forEach(l => l.classList.toggle('active', l.dataset.section == cur));
    tocDots.forEach(d => d.classList.toggle('active', d.dataset.section == cur));
  }
}
addEventListener('scroll', update, { passive: true });
update();

tocLinks.forEach(l => l.onclick = e => {
  e.preventDefault();
  document.getElementById(l.getAttribute('href').slice(1))?.scrollIntoView({ behavior: 'smooth' });
  if (innerWidth <= 1024) toc.classList.remove('show');
});

document.querySelectorAll('.code-copy').forEach(b => b.onclick = async () => {
  await navigator.clipboard.writeText(b.closest('.code-block').querySelector('code').textContent);
  b.textContent = 'copied!';
  b.classList.add('copied');
  setTimeout(() => { b.textContent = 'copy'; b.classList.remove('copied'); }, 1500);
});

function goSec(d) {
  const t = Math.max(1, Math.min(total, cur + d));
  sections.find(s => s.dataset.section == t)?.scrollIntoView({ behavior: 'smooth' });
}
function goCode(d) {
  if (!codes.length) return;
  let i = -1;
  for (let j = 0; j < codes.length; j++) if (codes[j].getBoundingClientRect().top <= 80) i = j;
  const next = d > 0 ? (i < codes.length - 1 ? i + 1 : 0) : (i > 0 ? i - 1 : codes.length - 1);
  codes[next].scrollIntoView({ behavior: 'smooth' });
}

onkeydown = e => {
  if (['INPUT','TEXTAREA'].includes(e.target.tagName)) return;
  const k = e.key.toLowerCase();
  if (k === 'g' && !e.shiftKey) {
    if (gWait) { scrollTo({ top: 0, behavior: 'smooth' }); gWait = false; return; }
    gWait = true; setTimeout(() => gWait = false, 400); return;
  }
  if (k === 'g' && e.shiftKey) return scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
  if (k === 'j' || k === 'arrowdown') { e.preventDefault(); goSec(1); }
  else if (k === 'k' || k === 'arrowup') { e.preventDefault(); goSec(-1); }
  else if (k === 'c') { e.preventDefault(); goCode(e.shiftKey ? -1 : 1); }
  else if (k === 't') { e.preventDefault(); toc.classList.toggle(innerWidth <= 1024 ? 'show' : 'hidden'); }
  else if (k === 'f') { e.preventDefault(); setFont(fontIdx + 1); }
  else if (k === 'd') { 
    e.preventDefault(); 
    const t = document.documentElement.dataset.theme === 'dark' ? 'light' : 'dark';
    document.documentElement.dataset.theme = t;
    try { localStorage.setItem('md-theme', t); } catch(e) {}
  }
  else if (k === '?' || (k === '/' && e.shiftKey)) { e.preventDefault(); help.classList.toggle('show'); }
  else if (k === 'escape') help.classList.remove('show');
};
help.onclick = e => { if (e.target === help) help.classList.remove('show'); };

if (window.Prism) setTimeout(() => Prism.highlightAll(), 50);
})();
</script>
</body>
</html>
